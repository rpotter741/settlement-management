import{v,r as c,j as s,B as h,n as d,k as y,K as k,R,J as b,o as S,D as g,L as H,M as L,N as C,O as A}from"./main.js";import{D as P,u as E,C as B,L as T}from"./CreateShell.js";import{E as O}from"./EditNameDescription.js";import{C as F,I as z,O as M,P as U}from"./ThresholdPreview.js";const $=()=>{const e=[9,29,49,69,84,99,100],n={},t=e.map(a=>{const r=v();return n[r]={name:"",max:a},r});return{id:v(),refId:v(),version:1,name:"",description:"",attributes:[],thresholds:{data:n,order:t},dependencies:{data:{},order:[]},tags:[],isValid:!1,status:"DRAFT",createdBy:""}},Q=[{keypath:"name",label:"Name"},{keypath:"description",label:"Description"},{keypath:"thresholds.data",label:"Thresholds",type:"group"},{keypath:"dependencies.data",label:"Dependencies",type:"group"}],V=({threshold:e,errors:n,index:t,id:a,handleModifierValidation:r,handleModifierChange:i})=>s.jsxs(h,{sx:{display:"flex",alignItems:"center",px:12,transition:"top 0.3s ease, left 0.3s ease",gap:2},children:[s.jsxs(d,{sx:{width:"33%",textAlign:"left"},variant:"h6",children:[e.name.charAt(0).toUpperCase()+e.name.slice(1),":"]}),s.jsx(P,{initialValues:{modifier:e.modifier},field:{name:"modifier",label:"Modifier",value:e.modifier,type:"number",textSx:{width:"100%"},validate:o=>o<0||o>5?"Value must be between 0 and 5":null,id:a,index:t},boxSx:{width:"66%"},shrink:!0,externalUpdate:i,parentError:(n==null?void 0:n.max)||null,onError:r})]},e.id),q=c.memo(V),K=({tool:e,id:n})=>{const{selectValue:t,updateTool:a,validateToolField:r}=y(e,n),i=t("dependencies.data"),o=t("dependencies.order"),{showSnackbar:l}=k(),[u,x]=c.useState(new Array(o.length).fill(!1));R.useEffect(()=>{console.log("order",o)},[o]);const j=c.useCallback((p,{id:f,index:m})=>{a(`dependencies.data.${f}.thresholds.${m}.modifier`,p),r(`dependencies.data.${f}.modifier`,p)},[a,r]),D=c.useCallback(p=>{const f=o.filter(w=>w!==p),m={...i};delete m[p],a("dependencies.data",m),a("dependencies.order",f)});return s.jsx(h,{children:o.map((p,f)=>i[p]&&s.jsxs(b,{defaultState:u[f],title:i[p].name,noDefaultHandler:()=>{const m=[...u];m[f]=!m[f],x(m)},children:[i[p].thresholds.map((m,w)=>s.jsx(q,{threshold:m,index:w,id:p,handleModifierChange:j},m.name)),s.jsxs(S,{variant:"contained",onClick:()=>D(p),children:["Remove ",i[p].name," Dependency"]})]},p))})},Y=({tool:e,setShowModal:n,id:t})=>{const{selectValue:a}=y(e,t);a("dependencies");const[r,i]=c.useState(!1),{showSnackbar:o}=k(),[l,u]=c.useState(null);return s.jsxs(h,{children:[s.jsxs(d,{variant:"h6",children:[e.charAt(0).toUpperCase()+e.slice(1)," Dependencies"]}),s.jsxs(d,{children:["Dependencies reflect how this ",e," interacts with others. For instance, if this ",e," is dependent on another ",e,", its own score will be modulated by the thresholds of the other ",e,". A dependency modifier of 0.75 means this ",e," will be 25% less at the other ",e,"'s threshold."]}),s.jsx(K,{tool:e,id:t}),s.jsx(S,{variant:"contained",color:"success","aria-label":"Add threshold",sx:{px:4},onClick:()=>{n("Select Category")},children:"Add Dependency"})]})},J={name:{name:"name",label:"Category Name",type:"text",tooltip:"The unique name of the category. This should clearly convey the category's purpose and role within the settlement mechanics.",validate:e=>e?e.length<3?"Category name must be at least 3 characters long":null:"Category name is required",keypath:"name"},description:{name:"description",label:"Description",type:"text",tooltip:"A brief description of the category and its role within the settlement mechanics.",multiline:!0,minRows:3,validate:e=>e?e.length<30?`Description must be at least 30 characters. You have ${30-e.length} characters remaining.`:null:"Description is required",keypath:"description"}};function W(e,n=2){return e.split(" ").map(t=>Math.floor(Number(t)/n)).join(" ")}const I=({attr:e})=>{const[n,t]=c.useState(!1);return s.jsxs(F,{sx:{pb:4,boxShadow:3,backgroundColor:"background.default"},children:[s.jsxs(h,{sx:{display:"flex",justifyContent:"center",alignItems:"center",gap:2,minHeight:100},children:[s.jsx(d,{variant:"h6",sx:{textAlign:"center"},children:e.name}),s.jsx(z,{viewBox:W(e.icon.viewBox,1),path:e.icon.d,size:40,color:e.iconColor})]}),s.jsx(g,{sx:{fontSize:"0.75rem"},children:"Per Level"}),s.jsxs(d,{variant:"body2",sx:{textAlign:"left",pl:2},children:["Max: ",e.balance.maxPerLevel]}),s.jsxs(d,{variant:"body2",sx:{textAlign:"left",pl:2},children:["Cost: ",e.balance.costPerLevel]}),s.jsxs(d,{variant:"body2",sx:{textAlign:"left",pl:2},children:["Health: ",e.balance.healthPerLevel]}),s.jsx(g,{children:s.jsx(H,{sx:{backgroundColor:"background.default",color:"primary.main"},label:n?"Hide Description":"Show Description",size:"small",onClick:()=>t(a=>!a)})}),s.jsx(L,{in:n,children:s.jsx(d,{variant:"body2",sx:{textAlign:"center",px:2},children:e.description})})]})},N=(e,n=[])=>{const[t,a]=c.useState([]);return c.useEffect(()=>{const r=n.map(o=>C.getQueryData([e,o])),i=n.filter((o,l)=>r[l]===void 0);i.length>0?A.post("/tools/fetchByIds",{tool:e,ids:i}).then(({data:o})=>{o.forEach(l=>{C.setQueryData([e,l.id],l)}),a(n.map(l=>C.getQueryData([e,l])))}):a(r)},[e,n]),t},_=({setShowModal:e,id:n})=>{const{edit:t}=y("category",n),a=N("attribute",t.attributes),r=()=>{e("Select Attribute")};return s.jsx(h,{children:s.jsxs(d,{variant:"h6",sx:{textAlign:"center",mb:2},children:[s.jsx(h,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:2},children:a.map(i=>s.jsx(I,{attr:i},i.refId))}),t.attributes.length<6&&s.jsx(S,{onClick:r,children:"Add Attribute"})]})})},G=({setShowModal:e})=>{const{tool:n,id:t}=E(),{edit:a}=y(n,t),[r,i]=c.useState(!1),[o,l]=c.useState(!1),[u,x]=c.useState(!1),[j,D]=c.useState(!1);return console.log("category",a),s.jsxs(h,{sx:{display:"grid",gridTemplateColumns:["1fr","1fr 1fr","repeat(3, 1fr)"],gridTemplateRows:"auto",alignItems:"start",justifyContent:"center",my:2,gap:2,backgroundColor:"background.paper",width:"100%",position:"relative",pb:2,overflowY:"auto",maxHeight:"calc(100vh - 200px)"},children:[s.jsx(O,{tool:"category",fields:J,id:t}),s.jsx(g,{sx:{gridColumn:"span 3"}}),s.jsx(b,{title:"Attributes",titleType:"h6",defaultState:r,styles:{width:"100%",mb:2},boxSx:{gridColumn:"span 3"},noDefaultHandler:()=>i(!r),children:s.jsx(_,{setShowModal:e,id:t})}),s.jsx(b,{title:"Thresholds",titleType:"h6",defaultState:o,styles:{width:"100%",mb:2},boxSx:{gridColumn:"span 3"},noDefaultHandler:()=>l(!o),children:s.jsx(M,{tool:"category",id:t})}),s.jsx(b,{title:"Dependencies",titleType:"h6",defaultState:u,styles:{width:"100%",mb:2},boxSx:{gridColumn:"span 3"},noDefaultHandler:()=>x(!u),children:s.jsx(Y,{tool:"category",setShowModal:e,id:t})}),s.jsx(b,{title:"Tags",titleType:"h6",defaultState:j,styles:{width:"100%",mb:2},boxSx:{gridColumn:"span 3"},noDefaultHandler:()=>D(!j),children:"tags"})]})},X=({label:e,data:n,isLoading:t,edit:a,type:r="h6"})=>s.jsxs(h,{sx:{...a,display:"flex",alignItems:"center",justifyContent:"start",gap:2},children:[s.jsxs(d,{variant:"h6",children:[e,":"]}),s.jsx(d,{variant:r,children:n||"None"})]}),Z=({threshold:e,style:n})=>e.name!==""?s.jsxs(h,{sx:{display:"flex",alignItems:"start",transition:"top 0.3s ease, left 0.3s ease",gap:2,...n},children:[s.jsxs(d,{sx:{width:"66%",textAlign:"left"},children:[e.name,":"]}),s.jsx(d,{children:e.modifier})]}):null,ee=({data:e,name:n})=>s.jsxs(h,{sx:{gridColumn:"span 3",display:"grid",gridTemplateRows:`repeat(${e.length+1}, 1fr)`,gridAutoFlow:"column"},children:[s.jsx(d,{variant:"body1",sx:{textAlign:"left",fontSize:"1.2rem",fontWeight:"bold",pl:"25%"},children:n}),e.map((t,a)=>s.jsx(Z,{threshold:t,style:{backgroundColor:a%2===0?"background.paper":"background.default"}},t.name))]}),te=()=>{var r,i,o;const{tool:e,id:n}=E(),{current:t}=y(e,n),a=N("attribute",t.attributes);return s.jsxs(h,{sx:{display:"grid",gridTemplateColumns:["1fr","1fr 1fr","repeat(3, 1fr)"],gridTemplateRows:"auto",alignItems:"start",justifyContent:"center",my:2,gap:2,backgroundColor:"background.paper",width:"100%",position:"relative"},children:[s.jsx(X,{data:t==null?void 0:t.name,label:"Name",edit:{gridColumn:"span 3"},type:"body1"}),s.jsxs(h,{sx:{gridColumn:"span 3",display:"flex",flexDirection:"column",gap:2,alignItems:"start",justifyContent:"center"},children:[s.jsx(d,{variant:"h6",children:"Description:"}),s.jsx(d,{sx:{textAlign:"start"},variant:"body1",children:(t==null?void 0:t.description)||"No description"})]}),s.jsx(g,{sx:{gridColumn:"span 3",borderColor:"#000"},children:"ATTRIBUTES"}),a.map(l=>s.jsx(I,{attr:l},l.refId)),s.jsx(g,{sx:{gridColumn:"span 3",borderColor:"#000"},children:"THRESHOLDS"}),s.jsx(U,{data:(r=t==null?void 0:t.thresholds)==null?void 0:r.data,order:(i=t==null?void 0:t.thresholds)==null?void 0:i.order,innerSx:{gridColumn:"span 3"}}),s.jsx(g,{sx:{gridColumn:"span 3",borderColor:"#000"},children:"DEPENDENCIES"}),(o=t==null?void 0:t.dependencies)==null?void 0:o.order.map(l=>s.jsx(h,{sx:{gridColumn:"span 1",display:"flex",flexDirection:"column",display:"grid",gridTemplateColumns:["1fr","1fr 1fr","repeat(3, 1fr)"],gap:2},children:s.jsx(ee,{data:t.dependencies.data[l].thresholds,name:t.dependencies.data[l].name})},l))]})},se=async({edit:e,selected:n,tool:t})=>{({...e.dependencies.data});const a={...e.dependencies.data};return console.log("selected",n),await A.post("/tools/fetchByIds",{tool:t,ids:n.ids}).then(({data:r})=>{r.forEach(i=>{C.setQueryData([t,i.refId,i.id],i)})}),n.ids.forEach((r,i)=>{const o=C.getQueryData([t,n.refIds[i],r]),l={...e.dependencies.data[r],name:o.name,thresholds:o.thresholds.order.map(u=>{var x;return{name:o.thresholds.data[u].name,modifier:((x=e.dependencies.data[r])==null?void 0:x.modifier)||1}})};a[r]=l}),console.log("existing",a),a},oe=({id:e})=>{var o;const{updateTool:n,edit:t}=y("category",e),[a,r]=c.useState([]);c.useEffect(()=>{var l;t&&r((l=t==null?void 0:t.dependencies)==null?void 0:l.order)},[(o=t==null?void 0:t.dependencies)==null?void 0:o.order]);const i=async(l,u)=>{const x=await se({edit:t,selected:u,tool:"category"});n("dependencies.data",x),n("dependencies.order",u.ids),n("dependencies.refIds",u.refIds)};return s.jsx(B,{tool:"category",id:e,initializeTool:$,validationFields:["name","description","thresholds","dependencies"],editComponent:G,previewComponent:te,checklistContent:Q,loadDisplayName:"Load Category",modalComponents:{"Select Attribute":T,"Select Category":T},modalComponentsProps:{"Select Attribute":{tool:"attribute",displayName:"Attributes",keypath:"attributes",selectionMode:!0,outerUpdate:n,outerTool:t},"Select Category":{tool:"category",displayName:"Categories",keypath:"dependencies.order",refKeypath:"dependencies.refIds",selectionMode:!0,outerUpdate:i,outerTool:t,dependency:!0}}})};export{oe as default};
