import{F as I,j as e,a8 as Ce,r as l,a0 as Ie,h as De,a9 as ke,aa as g,ab as Z,ac as be,ad as Ne,v as R,i as F,a3 as we,G as q,I as z,T as A,ae as Ee,af as Ge,ag as W,Q as S,J as ze,H as Ae,ah as Fe,ai as J,aj as Q,ak as Pe,al as Me,am as Oe,K as Re,an as ae,ao as Le,ap as oe,aq as He,ar as Ve,as as Be,at as Ke,M as U,A as Ye}from"./main.js";import{g as Xe}from"./hasParentProperty.js";import{u as ie,A as qe,G as We}from"./GlossaryListSelect.js";import"./glossaryThunks.js";const Je=I(e.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}),"ChevronRight"),Qe=I(e.jsx("path",{d:"M20 6h-8l-2-2H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2m-1 8h-3v3h-2v-3h-3v-2h3V9h2v3h3z"}),"CreateNewFolder"),L=I(e.jsx("path",{d:"M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8z"}),"Folder"),Ue=I(e.jsx("path",{d:"M4.01 2 4 22h16V8l-6-6zM13 9V3.5L18.5 9z"}),"InsertDriveFileSharp"),Ze=I(e.jsx("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8zm2 14h-3v3h-2v-3H8v-2h3v-3h2v3h3zm-3-7V3.5L18.5 9z"}),"NoteAdd"),_e=I(e.jsx("path",{d:"M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3z"}),"OpenInNew"),$e=I(e.jsx("path",{d:"M3 18h6v-2H3zM3 6v2h18V6zm0 7h12v-2H3z"}),"Sort");function et({tree:a,renderState:o}){if(!a.length)return[];const y=[],d=(c,f)=>{var v;y.push({id:c.id,depth:f}),c.fileType==="section"&&((v=o[c.id])!=null&&v.expanded)&&c.children&&c.children.forEach(n=>{d(n,f+1)})};return a.forEach(c=>{d(c,0)}),y}const ce=l.createContext({isDragging:!1,draggedType:null,draggedItem:null,startDrag:()=>{},endDrag:()=>{},lastDragged:null}),tt=({children:a})=>{const o=Ce();return e.jsx(ce.Provider,{value:o,children:a})},nt=()=>{const a=l.useContext(ce);if(!a)throw new Error("useGlossaryDrag must be used within a GlossaryDragProvider");return a},st={Fantasy:{"System Name":"Custom Name",glossary:"Tome",continent:"Continent",territory:"Territory",domain:"Domain",province:"Province",landmark:"Landmark",settlement:"Settlement",faction:"Faction",location:"Location",person:"Person",event:"Event",note:"Note"},"Sci-Fi":{"System Name":"Custom Name",glossary:"Codex",continent:"Galaxy",territory:"Sector",domain:"Solar System",province:"Planet",landmark:"Geographic Feature",settlement:"Metropolis",faction:"Corporation",location:"Point of Interest",person:"Person",event:"Event",note:"Note"},Agnostic:{},Western:{},Horror:{},Modern:{},Other:{}};function le({glossary:a,key:o}){var c,f;if(!a||!o)return"";const{genre:y,integrationState:d}=a;return((c=d==null?void 0:d.terms)==null?void 0:c[o])||((f=st[y])==null?void 0:f[o])||"yo shit busted bruh"}const rt=({structure:a,nodeMap:o,onRename:y,onDelete:d,onNewFile:c,onNewFolder:f})=>{const v=Ie(),[n,D]=l.useState(null),[N,j]=l.useState(null),[P,M]=l.useState(null),[O,w]=l.useState([]),[H,_]=l.useState(null),{draggedType:de,endDrag:$,startDrag:ue,draggedItem:lt}=nt(),{addNewTab:V}=De(),B=ke(),K=((B==null?void 0:B.themeKey)??"light")==="dark"?"rgba(255,255,255,0.08)":"rgba(0,0,0,0.08)",E=l.useRef(null),p=g(Z()),ee=g(be(p||"")),Y=g(Ne(p)),T=l.useMemo(()=>!a||a.length===0||!Y?[]:et({tree:a,renderState:Y??{}}),[a,Y]),pe=l.useMemo(()=>{if(!T||T.length===0)return{};const t={};return T.forEach((r,s)=>{t[r.id]=s}),t},[T]),te=t=>{t&&p&&v(ae({glossaryId:p,nodeId:t.id}))},he=(t,r)=>{t.preventDefault(),D({mouseX:t.clientX+2,mouseY:t.clientY-6,node:r})},k=()=>{D(null),j(null),M(null)},X=l.useRef(null),me=t=>t.metaKey||t.ctrlKey,ye=l.useCallback((t,r,s)=>{if(t.shiftKey&&H!==null){const h=[H,s].sort((u,b)=>u-b),m=T.slice(h[0],h[1]+1).map(u=>u.id),x=m.every(u=>O.includes(u));w(x?u=>u.filter(b=>!m.includes(b)):u=>Array.from(new Set([...u,...m])))}else me(t)?(w(h=>h.includes(r)?h.filter(m=>m!==r):[...h,r]),_(s)):(O.includes(r)?w([]):w([r]),_(s))},[T,H,O]),xe=l.useCallback((t,r)=>{o[r].entryType!==null&&V({name:o[r].name,id:r,mode:"edit",tool:o[r].entryType,tabId:R(),scroll:0,preventSplit:!1,activate:!0,side:"left",tabType:"glossary",glossaryId:p??void 0})},[o,V,p]),fe=({id:t,offset:r})=>{var re;if(p===null)return null;const s=g(Pe(p,t));if(!s)return null;const{expanded:h,rename:m}=g(Me(p,t)),[x,u]=l.useState(s.name),[b,se]=l.useState(h),ge=i=>{i.preventDefault(),X.current=setTimeout(()=>{ye(i,s.id,pe[s.id])},200)},ve=i=>{i.preventDefault(),X.current&&clearTimeout(X.current),xe(i,s.id)};l.useEffect(()=>{m&&E.current&&requestAnimationFrame(()=>{E.current!==null&&(E.current.focus(),E.current.select())})},[m]),l.useEffect(()=>{se(h)},[h]);const je=()=>{se(i=>!i),v(Le({glossaryId:p,nodeId:s.id,expanded:!b}))},G=(i,Te,Se)=>{u(i),te(Te),v(ae({glossaryId:p,nodeId:Se}))};return e.jsxs(F,{className:"glossary-node-item",sx:{pl:2,ml:r*2,display:"grid",cursor:"pointer",gridTemplateColumns:"24px 24px auto",alignItems:"center",minHeight:"36px","&:hover":{backgroundColor:K},backgroundColor:((re=n==null?void 0:n.node)==null?void 0:re.id)===t||O.includes(t)?K:"transparent"},onContextMenu:i=>{i.preventDefault(),he(i,s)},children:[s.fileType==="section"&&e.jsx(z,{onClick:je,size:"small",sx:{zIndex:3},children:b?e.jsx(Oe,{}):e.jsx(Je,{})}),s.fileType==="detail"&&e.jsx(F,{sx:{width:"24px"}}),s.fileType==="section"&&!Q.includes(s.entryType)?e.jsx(L,{sx:{color:"primary.main"}}):s.entryType!==null?J[s.entryType]:null,m?e.jsx(Re,{inputRef:E,variant:"standard",value:x,onBlur:i=>{if(x.trim()===""){G(s.name,null,s.id);return}G(x,null,s.id),y({...s,name:x})},onChange:i=>u(i.target.value),onKeyDown:i=>{if(i.key==="Enter"){if(x.trim()===""){G(s.name,null,s.id);return}G(x,null,s.id),y({...s,name:x})}else i.key==="Escape"&&G(s.name,null,s.id)}}):e.jsx(A,{role:"button",tabIndex:0,sx:{ml:1,textAlign:"left",width:"100%",cursor:"pointer",userSelect:"none",fontSize:"0.875rem"},onClick:ge,onDoubleClick:ve,children:s.name})]})},C=["person","note","event","location"],ne={continent:["territory","domain","province","landmark","settlement","faction",...C],territory:["domain","province","landmark","settlement","faction",...C],nation:["province","landmark","settlement","faction",...C],province:["landmark","settlement","faction",...C],landmark:["settlement","faction",...C],settlement:["faction",,...C],faction:[...C]};return e.jsxs(F,{children:[e.jsxs(we,{variant:"text",sx:{mb:.33},children:[e.jsx(q,{title:e.jsx(A,{children:"Add New Section"}),children:e.jsx("span",{children:e.jsx(z,{disabled:!p,onClick:t=>M(t.currentTarget),size:"small",children:e.jsx(Qe,{})})})}),e.jsx(q,{title:e.jsx(A,{children:"Add New Detail"}),children:e.jsx("span",{children:e.jsx(z,{disabled:!p,onClick:t=>j(t.currentTarget),size:"small",children:e.jsx(Ze,{})})})}),e.jsx(q,{title:e.jsx(A,{children:"Sort"}),children:e.jsx(z,{size:"small",children:e.jsx($e,{})})})]}),T&&T.map(t=>{const r=o[t.id];return r?e.jsx(Ee,{type:r!=null&&r.entryType&&(r==null?void 0:r.entryType)in ne?ne[r.entryType].filter(s=>typeof s=="string").filter(s=>s!==void 0):[],handleAdd:()=>{},draggedType:de,endDrag:$,styleType:"glossary",bg2:"success.main",onReorder:()=>{},children:e.jsx(Ge,{type:r.entryType??"",item:r,startDrag:ue,endDrag:$,children:e.jsx(fe,{id:r.id,offset:t.depth},r.id)})},t.id):null}),e.jsx(W,{open:!!n,onClose:k,anchorReference:"anchorPosition",anchorPosition:n?{top:n.mouseY,left:n.mouseX}:void 0,children:(n==null?void 0:n.node)&&e.jsxs(e.Fragment,{children:[e.jsxs(S,{onClick:t=>{t.preventDefault(),n.node&&V({name:n.node.name,id:n.node.id,mode:"edit",tool:n.node.entryType,tabId:R(),scroll:0,preventSplit:!1,activate:!0,side:"left",tabType:"glossary",glossaryId:p??void 0}),k()},sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(_e,{}),"Open"]}),e.jsxs(S,{onClick:t=>{te(n.node),k()},sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(ze,{}),"Rename"]}),e.jsxs(S,{onClick:t=>{t.preventDefault(),n.node&&(d(n.node),k())},sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Ae,{}),"Delete"]}),n.node.fileType==="section"&&e.jsxs(e.Fragment,{children:[e.jsxs(S,{onClick:t=>{t.preventDefault(),j(t.currentTarget)},sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Ue,{}),"New Detail"]}),n.node.entryType!=="faction"&&e.jsxs(S,{onClick:t=>{t.preventDefault(),M(t.currentTarget)},sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(L,{}),"New Section"]})]}),e.jsx(S,{onClick:t=>{t.preventDefault(),n.node&&console.log(Xe({node:n.node,nodeStructure:o}))},children:"Print Lineage Names"})]})}),e.jsx(W,{anchorEl:N,open:!!N,onClose:()=>j(null),anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"left"},children:Fe.map(t=>e.jsxs(S,{onClick:r=>{var s;r.preventDefault(),c({id:R(),parentId:((s=n==null?void 0:n.node)==null?void 0:s.id)||null,entryType:t}),k()},sx:{display:"flex",alignItems:"center",gap:2},children:[J[t]||e.jsx(L,{sx:{color:"primary.main"}}),le({glossary:ee,key:t})]},t))}),e.jsx(W,{anchorEl:P,open:!!P,onClose:()=>M(null),anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"left"},children:Q.map((t,r)=>{var h,m;const s=Q.indexOf(((h=n==null?void 0:n.node)==null?void 0:h.entryType)||"");return n!==null&&(s===-1||(m=n==null?void 0:n.node)!=null&&m.fileType&&n.node.fileType!=="section"||r<=s)?null:e.jsxs(S,{onClick:x=>{var u;x.preventDefault(),f({id:R(),name:"Untitled",parentId:((u=n==null?void 0:n.node)==null?void 0:u.id)||null,entryType:t}),k()},sx:{display:"flex",alignItems:"center",justifyContent:"start",gap:4},children:[J[t]||e.jsx(L,{sx:{color:"primary.main"}}),le({glossary:ee,key:t})]},t)})})]})},at=({})=>{const a=g(Z()),o=g(oe()),y=o.find(P=>P.id===a),[d,c]=l.useState(y||null),{roots:f,nodeMap:v}=g(He(a||"")),{handleAddFolder:n,handleDelete:D,handleRename:N,handleAddEntry:j}=ie({glossary:d,glossaries:o,glossaryId:a,setGlossary:c});return e.jsxs(F,{sx:{height:"100vh"},children:[e.jsxs(F,{sx:{width:"100%",display:"flex",justifyContent:"center",position:"relative"},children:[e.jsx(z,{sx:{position:"absolute",left:0,top:"50%",transform:"translateY(-50%)"},onClick:()=>{},children:e.jsx(qe,{})}),e.jsx(A,{variant:"h6",sx:{marginLeft:2},children:d&&d.name})]}),e.jsx(tt,{children:e.jsx(rt,{structure:f,nodeMap:v,onRename:N,onDelete:D,onNewFile:j,onNewFolder:n})})]})},pt=()=>{Ve(),Be();const a=g(Z()),o=g(oe()),y=o.find(j=>j.id===a),[d,c]=l.useState(y||null);l.useRef([]);const[f,v]=l.useState({}),{ui:n}=Ke(),{handleSelect:D}=ie({glossary:d,glossaries:o,glossaryId:a,setGlossary:c});return["Overview","Graph","Entries","Terms","Templates","Settings","Palette"].indexOf((n==null?void 0:n.activeTab)||"Overview"),e.jsx(U,{layout:!0,sx:{display:"flex",flexDirection:"column",padding:2,height:"100%",position:"relative"},children:e.jsx(Ye,{mode:"wait",children:d?e.jsx(U,{layout:!0,layoutId:"glossary-sidebar",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.25},children:e.jsx(at,{})}):e.jsx(U,{layout:!0,layoutId:"glossary-sidebar",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.25},children:e.jsx(We,{handleSelect:D})})})})};export{pt as default};
