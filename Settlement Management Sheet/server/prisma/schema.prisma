generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ContentTypes {
  OFFICIAL
  CUSTOM
}

enum Status {
  DRAFT
  PUBLISHED
  ARCHIVED
}

/////////////////// ATTRIBUTE //////////////////////

model Attribute {
  refId               String       @id @default(uuid())
  id                  String       @unique // ID for versioning or app-level tracking
  version             Int // per id
  positive            Boolean
  name                String
  description         String
  balance             Json
  thresholds          Json
  settlementPointCost Json
  icon                Json
  iconColor           String
  tags                String[] // Array of strings for tags
  isValid             Boolean
  status              Status
  contentType         ContentTypes // for separating official from custom content
  createdBy           String // Potential foreign key to User model in the future
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  @@index([contentType])
  @@index([tags])
  @@index([id, updatedAt(sort: Desc)])
}

////////////////// CATEGORY //////////////////////////

model Category {
  refId        String       @id @default(uuid())
  id           String       @unique // ID for versioning or app-level tracking
  version      Int // per id
  name         String
  description  String
  attributes   Json
  thresholds   Json
  dependencies Json
  tags         String[]
  isValid      Boolean
  status       Status
  contentType  ContentTypes
  createdBy    String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([contentType])
  @@index([tags])
  @@index([refId, updatedAt(sort: Desc)])
}

////////////////// EVENT //////////////////////////

model Event {
  refId           String       @id @default(uuid())
  id              String       @unique // ID for versioning or app-level tracking
  version         Int // per id
  name            String
  description     String
  flavorText      Json
  narrativeWeight String?
  phases          Json
  replacement     Json
  links           String[]
  entryPhaseId    String
  isValid         Boolean
  status          Status
  contentType     ContentTypes
  createdBy       String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  //flavorText:
  //trivial: string,
  //minor: string,
  //...
  //significant: string

  //phases:
  //[
  //  {
  //    type: 'active / immediate / passive / indefinite'
  //    impacts: see-below,
  //    length: 0+,
  //    productivity: 0+,
  //  },
  //]

  //resolutions:
  //[
  //{
  //uuid():
  //{
  //name:
  //description:
  //impacts:
  //}
  //}
  //]
}

////////////////// LISTENER //////////////////////////

model Listener {
  refId               String       @id @default(uuid())
  id                  String       @unique // ID for versioning or app-level tracking
  version             Int // per id
  name                String
  description         String
  conditionEventPairs Json
  active              Boolean?
  isValid             Boolean
  status              Status
  contentType         ContentTypes
  createdBy           String
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  //conditions:
  //array of logic objects, eg:
  //  [
  //    {
  //    logic: 'none',
  //   condition: {
  //     attribute_base_id: value
  //   }
  // },
  // {
  //  logic: 'and',
  // condition: {
  //  attribute_base_id: value,
  // attribute_base_id: value,
  // }
  // }
  // ]
}

/////////////////// KITS //////////////////////////

model Kit {
  refId       String       @id @default(uuid())
  id          String       @unique
  name        String
  data        Json
  contentType ContentTypes
  createdBy   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

/////////////////// KEYS ///////////////////////////

model Key {
  refId       String        @id @default(uuid())
  id          String        @unique
  name        String        @unique
  version     Int
  description String?
  contentType ContentTypes
  createdBy   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  backLinks   KeySettings[] // just want keySetting ids
}

model KeySettings {
  id               String       @id @default(uuid())
  refId            String
  delay            Int
  duration         Int
  durationType     String
  severityOverTime Json
  contentType      ContentTypes
  createdBy        String
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  key              Key          @relation(fields: [refId], references: [refId], onDelete: Cascade)
}

////////////////// STATUS //////////////////////////
enum StatusType {
  Weather
  Morale
  Settlement
}

enum StatusMode {
  Simple
  Advanced
}

model gameStatus {
  refId       String       @id @default(uuid())
  id          String       @unique // ID for versioning or app-level tracking
  version     Int // per id
  name        String
  description String
  type        StatusType
  steps       Json
  mode        StatusMode
  isValid     Boolean
  status      Status
  contentType ContentTypes
  createdBy   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

////////////////// BUILDING //////////////////////////

model Building {
  refId        String       @id @default(uuid())
  id           String       @unique // ID for versioning or app-level tracking
  version      Int // per id
  name         String
  description  String
  metrics      Json
  attributes   String[]
  upgradeTree  Json?
  initialCost  Json
  impacts      Json
  flavorText   String?
  dependencies String[]
  isValid      Boolean
  status       Status
  contentType  ContentTypes
  createdBy    String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  //upgrades:
  //upgrade_base_id
  //upgrade_ref_id
}

////////////////// UPGRADE //////////////////////////
enum UpgradeType {
  Settlement
  Leadership
  Building
}

model Upgrade {
  refId       String       @id @default(uuid())
  id          String       @unique // ID for versioning or app-level tracking
  version     Int // per id
  name        String
  description String
  root        String
  nodes       Json
  isValid     Boolean
  status      Status
  contentType ContentTypes
  createdBy   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  //impact:
  //attribute_base_id: value
  //ability:
  //description of skill. eg, 'Adaptive Resources: If losing an attribute in one category, you can spend from another at a 1:1 settlement point cost ratio. E.g., if losing 3 food, you could lose 1 medical supply instead. Once per turn.'
}

////////////////// TRADE HUB //////////////////////////

model TradeHub {
  refId       String       @id @default(uuid())
  id          String       @unique // ID for versioning or app-level tracking
  version     Int // per id
  name        String
  description String
  stock       Json
  region      String
  location    String
  trend       String
  trendRange  Int[]
  faction     String?
  isValid     Boolean
  status      Status
  contentType ContentTypes
  createdBy   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // region pulls from narrative data
  // location pulls from narrative data
  // stock:
  // attribute_base_id
  // attribute name
  // number
  // trend: tuple (eg, -1, 1) for weekly loss/gain limit (0, 2) would be increasing, (-5, -2) would be decreasing
}

////////////////// SETTLEMENT TYPE //////////////////////////

model SettlementType {
  refId       String       @id @default(uuid())
  id          String       @unique // ID for versioning or app-level tracking
  version     Int // per id
  name        String
  description String
  upgrades    String[]
  isValid     Boolean
  status      Status
  contentType ContentTypes
  createdBy   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

////////////////// SETTLEMENT //////////////////////////

model Settlement {
  refId         String       @id @default(uuid())
  id            String       @unique // ID for versioning or app-level tracking
  version       Int // per id
  name          String
  stats         Json
  population    Json
  categories    Json
  buildings     Json
  eventLog      Json
  narrativeData String // foreign key later
  isValid       Boolean
  contentType   ContentTypes
  createdBy     String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  //stats includes:
  // level
  // health
  // gold (currency?)
  // calendar id

  //pop includes:
  // DM (array)
  // players (array)
  // residents (array)
  // aristocrats (array)

  //categories includes:
  //category_refId:
  // bonus
  // attribute refId:
  // current
  // bonus

  //eventLog includes:
  // eventId keys:
  // narrative data selections (array of details in [[description tag]] order)
  // impacts
  // dates (irl && calendar)
}

////////////// APT ////////////

model APT {
  refId           String       @id @default(uuid())
  id              String       @unique
  version         Int
  name            String
  description     String
  display         Json
  eventThresholds Json
  progressType    String
  decay           Int
  contentType     ContentTypes
  createdBy       String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

////////////// Action ////////////

model Action {
  refId       String       @id @default(uuid())
  id          String       @unique
  version     Int
  name        String
  description String
  contentType ContentTypes
  createdBy   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  effects     Json
  conditions  Json?
  cooldown    String?
  flavorText  String[]
}

////////////// StoryThread ////////////

model StoryThread {
  refId       String       @id @default(uuid())
  id          String       @unique
  version     Int
  name        String
  description String
  contentType ContentTypes
  createdBy   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  origin      Json
  primaryKey  Json
}

////////////// Glossary /////////////

enum GlossShape {
  folder
  file
}

enum EntryTypes {
  region
  location
  poi
  person
  faction
}

model Glossary {
  id          String         @id @default(uuid())
  name        String
  description String?
  createdBy   String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  contentType ContentTypes
  nodes       GlossaryNode[]
}

model GlossaryNode {
  id         String         @id @default(uuid())
  name       String
  entryType  EntryTypes?
  type       GlossShape
  parentId   String?
  children   GlossaryNode[] @relation("NodeHierarchy")
  parent     GlossaryNode?  @relation("NodeHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  glossaryId String
  glossary   Glossary       @relation(fields: [glossaryId], references: [id], onDelete: Cascade)
  sortIndex  Int            @default(0)
}

////////////// Region ////////////

model Region {
  refId            String       @id @default(uuid())
  id               String       @unique
  version          Int
  name             String
  description      String
  contentType      ContentTypes
  createdBy        String
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  tags             String[]
  climate          String
  terrain          String
  factions         String[]
  population       Json
  notableLocations String[]
  resources        String[]
}

////////////// Location ////////////

model Location {
  refId       String       @id @default(uuid())
  id          String       @unique
  version     Int
  name        String
  description String
  contentType ContentTypes
  createdBy   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  tags        String[]
  type        String
  region      String[]
  climate     String
  terrain     String
  eventLog    String[]
}

////////////// POI ////////////

model POI {
  refId            String       @id @default(uuid())
  id               String       @unique
  version          Int
  name             String
  description      String
  contentType      ContentTypes
  createdBy        String
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  tags             String[]
  type             String
  region           String[]
  currentOccupants String[]
  nearbyFeatures   Json
}

////////////// Person ////////////

model Person {
  refId         String       @id @default(uuid())
  id            String       @unique
  version       Int
  name          String
  description   String
  contentType   ContentTypes
  createdBy     String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  tags          String[]
  occupation    String
  title         String
  traits        String[]
  faction       String
  location      String
  relationships Json
  notoriety     String
}

////////////// Faction ////////////

model Faction {
  refId          String       @id @default(uuid())
  id             String       @unique
  version        Int
  name           String
  description    String
  contentType    ContentTypes
  createdBy      String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  tags           String[]
  leader         String
  homeBase       String
  disposition    Json
  allies         String[]
  enemies        String[]
  influence      Int
  notoriety      Int
  cultureTags    String[]
  activeKeys     String[]
  passiveBonuses Json
}
