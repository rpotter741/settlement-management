import{a3 as O,a2 as h,bV as Y,bW as H,ag as W,a1 as Q,u as X,bX as Z,ah as P,b4 as _,r as v,au as q,bC as J,bm as B,bY as ee,aK as te,bD as se,j as n,bQ as K,bs as ne,R as z,b6 as ae,bZ as re,$ as F,b_ as oe,b$ as le,bx as L,B as M,T as V,c0 as ie,I as ce,ak as de,c1 as ue,c2 as pe,aG as ye,Q as he,S as me,U as ge,V as be,aN as fe,c3 as xe,c4 as ve,O as Se}from"./main.js";import{T as je}from"./TabbedContent.js";function Ee({glossaryId:e,subTypeId:a,entryId:t}){return async(i,I)=>{var j;const c=I(),S=c.glossary.glossaries.edit.byId[e],s=c.glossary.glossaries.static.byId[e];if(!s||!S){i(O({message:"Glossary not found.",type:"error",duration:3e3}));return}const d=S.entries[t],m=s.entries[t];if(!m||!d){i(O({message:"Entry not found.",type:"error",duration:3e3}));return}try{const D=((j=c.dirty.glossary[t])==null?void 0:j.dirtyKeypaths)||{},E=Object.keys(D).map(r=>{const w=h.get(m,r),g=h.get(d,r);if(g===void 0)return{keypath:r,value:null};if(w!==g)return{keypath:r,value:g};if(w===g)return null}).filter(r=>r!==null);if(E.length>0){const r={};E.forEach(w=>{const{keypath:g,value:o}=w;r[g]=o}),await Y({id:t,subTypeId:a,groups:h.cloneDeep(d.groups),primaryAnchorValue:d.primaryAnchorValue,secondaryAnchorValue:d.secondaryAnchorValue}),i(H({scope:"glossary",id:t}))}}catch{i(O({message:"Error updating glossary entry. Try again later.",type:"error",duration:3e3}))}}}function Te({glossaryId:e,entryId:a,subTypeId:t,name:i}){return{name:i,batchSaveFn:async()=>{W(Ee({glossaryId:e,entryId:a,subTypeId:t}))},intervalMs:5e3}}const Ce=({tab:e,editComponent:a,editComponentProps:t,previewComponent:i,previewComponentProps:I})=>{const c=Q(),{showModal:S,closeModal:s}=X(),{tool:d,id:m,mode:j,side:D,tabId:E,glossaryId:r,tabType:w}=e,g=C=>{const x=h.cloneDeep(e.viewState.lastSaved||{});x[C]=new Date().toISOString(),c(ae({tabId:E,keypath:"viewState.lastUpdated",updates:x}))};if(!r)return null;const{node:o,entry:u}=Z(r,m);console.log(u,"entry in shell");const f=P(_(r)),k=v.useMemo(()=>o?q({node:o,nodeStructure:f,includeNephews:!0}):{},[o,f]);J();const b=v.useCallback((C,x,A)=>{c(B({glossaryId:r,entryId:u.id,content:{[x]:C},nukedIds:A}))},[c,r,u]),p=v.useCallback((C,x,A)=>{console.log(C,x,A,"onadddata");const T=ee(C,A),G=T.value[T.order[0]],y=h.cloneDeep(u),l=h.get(y,`groups.${x}.properties.${A}`,null);l&&(l.value={...l.value,[T.order[0]]:G},l.order=[...l.order||[],T.order[0]],c(B({glossaryId:r,entryId:u.id,content:{[`groups.${x}.properties.${A}`]:l}})))},[c,u,r]),N=v.useCallback((C,x)=>{const A=h.cloneDeep(u),T=h.get(A,x,null);T&&(T.order=(T.order||[]).filter(G=>G!==C),delete T.value[C],c(B({glossaryId:r,entryId:u.id,content:{[x]:T}})))},[u,r,c]),R=P(te((o==null?void 0:o.subTypeId)||""));se(Te({glossaryId:r,entryId:m,subTypeId:(o==null?void 0:o.subTypeId)||"",name:(u==null?void 0:u.name)||"Glossary Entry"}));const $=v.useMemo(()=>({tab:e,tool:d,id:m,mode:j,side:D,tabId:E,glossaryId:r,entry:u,node:o,inheritanceMap:k,updateLastSaved:g,showModal:S,closeModal:s,source:u,handleChange:b,onAddData:p,liveEdit:!0,onRemove:N}),[e,d,m,j,D,E,r,u,g,S,s,o,k,u]);return u?n.jsx(ne.Provider,{value:$,children:j==="edit"&&a?z.createElement(a,{subType:R,mode:"preview",editId:(o==null?void 0:o.subTypeId)||null,mt:0,offerSubTypeChange:!0,glossaryId:r,...t}):j==="preview"&&i?z.createElement(i,{...I}):n.jsx("div",{style:{padding:"16px"},children:"Yo shit is busted, bruh"})}):n.jsx(K,{mode:j,variant:"default",children:"Loading..."})},we=({content:e})=>{const a=re({extensions:le,content:e,editable:!1});return n.jsx(F,{sx:{width:"100%",maxHeight:"calc(100vh - 200px)",overflowY:"auto",borderRadius:2},children:n.jsx(oe,{editor:a})})},Ae=({keypath:e,header:a})=>{const{entry:t}=L();return n.jsxs(M,{sx:{display:"flex",justifyContent:"start",alignItems:"start",mt:2,width:"100%",flexDirection:"column"},children:[n.jsx(V,{sx:{fontSize:"1.25rem",width:"100%",borderBottom:"1px solid",borderColor:"divider",textAlign:"left",fontWeight:600},children:a}),n.jsx(V,{sx:{fontSize:"1.1rem",width:"100%",textAlign:"left",ml:2},children:Array.isArray(t[e])?t[e].map(i=>h.capitalize(i)).join(", "):h.capitalize(t[e])||"No data available"})]})},Ie={nations:"Nations",regions:"Regions",locations:"Locations",resources:"Resources",population:"Population",climate:"Climate",terrain:"Terrain",capital:"Capital",languages:"Languages",persons:"Persons",eventLog:"Event Log",geography:"Geography",type:"Type",region:"Regions",landmark:"Landmark",settlement:"Settlement",collective:"Faction",person:"Person",event:"Event",lore:"Note"},De=({keypathArray:e})=>n.jsxs(M,{sx:{width:"100%",p:2,borderLeft:"1px solid",borderColor:"divider"},children:[n.jsx(M,{sx:{width:"100%",display:"flex",justifyContent:"start",alignItems:"center",borderBottom:"1px solid",borderColor:"primary.main",flexWrap:"wrap"},children:ie.map(a=>{const t=(Math.random()*(10*Math.random())).toFixed(0),i=t==="1"?"Backlink":"Backlinks";return Number(t)<1?null:n.jsx(ce,{title:`${t} ${h.capitalize(a)} ${i}`,children:n.jsxs(M,{sx:{display:"flex",flexDirection:"column",alignItems:"center",p:1,cursor:"pointer"},children:[de[a],n.jsxs(V,{variant:"body2",sx:{mt:.5},children:["(",t,")"]})]})},a)})}),e.map(a=>n.jsx(Ae,{keypath:a,header:Ie[a]},a))]}),ke={continent:["nations","regions","locations","resources","population","climate","terrain"],region:[],nation:["continent","regions","capital","population","languages","persons","eventLog","locations","geography"],territory:[],landmark:["region","climate","type"],settlement:[],collective:[],location:["terrain","climate","type","region"],person:[],event:[],lore:[]},Ge=()=>{const{entry:e,node:a}=L(),{entryType:t}=a;return n.jsxs(F,{sx:{display:"grid",height:"100%",width:"100%",gridTemplateColumns:"2fr 1fr"},children:[n.jsxs(F,{sx:{width:"100%",py:2,borderColor:"divider",display:"flex",flexDirection:"column"},children:[n.jsx(V,{variant:"h2",sx:{mb:2},children:e.name}),n.jsx(we,{content:e.description})]}),n.jsx(De,{keypathArray:ke[t]})]})};function Oe({glossaryId:e,newSubTypeId:a,entryId:t}){return async(i,I)=>{const c=I(),S=c.glossary.glossaries.edit.byId[e],s=c.glossary.glossaries.static.byId[e];if(!s||!S){i(O({message:"Glossary not found.",type:"error",duration:3e3}));return}const d=h.cloneDeep(S.entries[t]),m=h.cloneDeep(s.entries[t]);if(!m||!d){i(O({message:"Entry not found.",type:"error",duration:3e3}));return}const j=Object.values(h.cloneDeep(c.subType.groups.edit)),D=Object.values(h.cloneDeep(c.subType.properties.edit)),E=c.subType.static[a];if(!E){i(O({message:"Sub-type not found.",type:"error",duration:3e3}));return}const{groups:r,primaryAnchorId:w,secondaryAnchorId:g}=ue(E,j,D),o={};Object.values(d.groups).forEach(b=>{Object.values(b.properties).forEach(p=>o[p.id]=p)});const u={};Object.values(r).forEach(b=>{Object.values(b.properties).forEach(p=>u[p.id]=p)});let f=[],k=[];Object.keys(o).forEach(b=>{u[b]?f.push(o[b].name):k.push(o[b].name)}),Object.values(r).forEach(b=>{Object.values(b.properties).forEach(p=>{o[p.id]&&(p.value=o[p.id].value,p.order&&(p.order=o[p.id].order),w===p.id&&(d.primaryAnchorValue=p.value),g===p.id&&(d.secondaryAnchorValue=p.value))})}),d.primaryAnchorId=w,d.secondaryAnchorId=g,d.subTypeId=a,d.groups=r,i(pe({componentKey:"ConfirmChangeEntrySubType",props:{preserved:f,removed:k,updatedEntry:d,oldEntry:m,newSubTypeId:a,glossaryId:e}}))}}const Me=({disabled:e,editId:a})=>{const{source:t,glossaryId:i}=L(),c=P(ye).filter(s=>s.entryType===(t==null?void 0:t.entryType));console.log(t==null?void 0:t.subTypeId);const S=s=>{console.log("Pushing subtype change to ",s),W(Oe({glossaryId:i,newSubTypeId:s,entryId:t.id}))};return n.jsxs(he,{fullWidth:!0,children:[n.jsx(me,{id:"change-subtype-label",children:"Sub-Type"}),n.jsx(ge,{disabled:e,labelId:"change-subtype-label",value:((t==null?void 0:t.subTypeId)||a)??"",label:"Sub-Type",onChange:s=>S(s.target.value),renderValue:s=>{const d=c.find(m=>m.id===s);return d?d.name:"Select Sub-Type"},children:c.map(s=>n.jsx(be,{value:s.id,children:s.name},s.id))})]})},Ne=({subType:e,mode:a,editId:t,mt:i=6,disableResize:I=!1,offerSubTypeChange:c=!1,glossaryId:S})=>{var G;const{source:s,setSource:d,handleChange:m,onAddData:j,onRemove:D,liveEdit:E,node:r,tabId:w}=L();console.log(s);const[g,o]=v.useState((s==null?void 0:s.name)||`New ${e.name} Entry`),u=P(fe),f=v.useMemo(()=>(console.log("generating tabs"),console.log(e==null?void 0:e.name),e?e.groups.map(y=>{const l=u.find(U=>U.id===y.groupId);return{name:(l==null?void 0:l.displayName)||"",key:(l==null?void 0:l.id)||"",props:{glossaryId:S,mode:a,group:l,source:s,onAddData:j,handleChange:m,onRemove:D,disableResize:I,liveEdit:E,subType:e}}}):[]),[e,s]),[k,b]=v.useState(((G=f[0])==null?void 0:G.key)||""),[p,N]=v.useState(0),[R,$]=v.useState(0),C=(y,l)=>{b(y),$(p),N(l)};v.useEffect(()=>{f.length&&!f.find(y=>y.key===k)&&(b(f[0].key),N(0))},[f,k]);const x=v.useMemo(()=>(console.log("redrawing component map"),f.reduce((y,l)=>(y[l.name]=xe,y),{})),[e,s]),A=v.useMemo(()=>h.debounce((y,l)=>{W(ve({node:{...l,name:y},tabId:w}))},300),[]),T=y=>{const l=y.target.value;o(l),E&&A(l,r)};return n.jsxs(K,{mode:"edit",variant:"default",outerStyle:{mt:i},children:[n.jsxs(M,{sx:{display:"flex",gap:2,alignItems:"center",mt:4},children:[n.jsx(Se,{variant:"outlined",fullWidth:!0,label:"Name",value:g,onChange:T}),n.jsx(Me,{disabled:!c,editId:t})]}),n.jsx(je,{tabs:f,componentMap:x,activeTab:k,handleTabClick:(y,l)=>C(y,l),lastIndex:R,isTool:!1})]})},Le=({tab:e})=>n.jsx(Ce,{tab:e,editComponent:Ne,editComponentProps:{},previewComponent:Ge,previewComponentProps:{}});export{Le as default};
