import{F as b,j as e,a8 as Ie,r as i,a0 as ue,h as ke,a9 as Ae,aa as D,ab as pe,ac as Ee,ad as be,v as B,i as O,a3 as Ne,G as _,I as L,T as V,ae as Ge,af as we,ag as $,Q as C,J as ze,H as Fe,a1 as Me,ah as Re,ai as ee,aj as te,ak as Pe,al as He,am as Le,K as Ve,an as ce,ao as Oe,ap as Ke,aq as Be,ar as Ye,as as Ue,at as ne,au as We}from"./main.js";import{g as Xe}from"./hasParentProperty.js";import{t as H}from"./glossaryThunks.js";import{G as qe,A as Je}from"./GlossarySidePanelWrapper.js";const Qe=b(e.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}),"ChevronRight"),Ze=b(e.jsx("path",{d:"M20 6h-8l-2-2H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2m-1 8h-3v3h-2v-3h-3v-2h3V9h2v3h3z"}),"CreateNewFolder"),Y=b(e.jsx("path",{d:"M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8z"}),"Folder"),_e=b(e.jsx("path",{d:"M4.01 2 4 22h16V8l-6-6zM13 9V3.5L18.5 9z"}),"InsertDriveFileSharp"),$e=b(e.jsx("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8zm2 14h-3v3h-2v-3H8v-2h3v-3h2v3h3zm-3-7V3.5L18.5 9z"}),"NoteAdd"),et=b(e.jsx("path",{d:"M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3z"}),"OpenInNew"),tt=b(e.jsx("path",{d:"M3 18h6v-2H3zM3 6v2h18V6zm0 7h12v-2H3z"}),"Sort");function nt({tree:o,renderState:s}){if(!o.length)return[];const u=[],y=(c,h)=>{var v;u.push({id:c.id,depth:h}),c.fileType==="section"&&((v=s[c.id])!=null&&v.expanded)&&c.children&&c.children.forEach(j=>{y(j,h+1)})};return o.forEach(c=>{y(c,0)}),u}const he=i.createContext({isDragging:!1,draggedType:null,draggedItem:null,startDrag:()=>{},endDrag:()=>{},lastDragged:null}),st=({children:o})=>{const s=Ie();return e.jsx(he.Provider,{value:s,children:o})},lt=()=>{const o=i.useContext(he);if(!o)throw new Error("useGlossaryDrag must be used within a GlossaryDragProvider");return o},rt={Fantasy:{"System Name":"Custom Name",glossary:"Tome",continent:"Continent",territory:"Territory",domain:"Domain",province:"Province",landmark:"Landmark",settlement:"Settlement",faction:"Faction",location:"Location",person:"Person",event:"Event",note:"Note"},"Sci-Fi":{"System Name":"Custom Name",glossary:"Codex",continent:"Galaxy",territory:"Sector",domain:"Solar System",province:"Planet",landmark:"Geographic Feature",settlement:"Metropolis",faction:"Corporation",location:"Point of Interest",person:"Person",event:"Event",note:"Note"},Agnostic:{},Western:{},Horror:{},Modern:{},Other:{}};function de({glossary:o,key:s}){var c,h;if(!o||!s)return"";const{genre:u,integrationState:y}=o;return((c=y==null?void 0:y.terms)==null?void 0:c[s])||((h=rt[u])==null?void 0:h[s])||"yo shit busted bruh"}const at=({structure:o,nodeMap:s,onRename:u,onDelete:y,onMultipleDelete:c,onNewFile:h,onNewFolder:v})=>{const j=ue(),[l,w]=i.useState(null),[U,z]=i.useState(null),[W,F]=i.useState(null),[I,N]=i.useState([]),[K,a]=i.useState(null),{draggedType:T,endDrag:k,startDrag:M,draggedItem:se}=lt(),{addNewTab:X}=ke(),q=Ae(),J=((q==null?void 0:q.themeKey)??"light")==="dark"?"rgba(255,255,255,0.08)":"rgba(0,0,0,0.08)",R=i.useRef(null),f=D(pe()),le=D(Ee(f||"")),Q=D(be(f)),S=i.useMemo(()=>!o||o.length===0||!Q?[]:nt({tree:o,renderState:Q??{}}),[o,Q]),fe=i.useMemo(()=>{if(!S||S.length===0)return{};const t={};return S.forEach((r,n)=>{t[r.id]=n}),t},[S]),re=t=>{t&&f&&j(ce({glossaryId:f,nodeId:t.id}))},me=(t,r)=>{t.preventDefault(),w({mouseX:t.clientX+2,mouseY:t.clientY-6,node:r})},A=()=>{w(null),z(null),F(null)},Z=i.useRef(null),ye=t=>t.metaKey||t.ctrlKey,ge=i.useCallback((t,r,n)=>{if(t.shiftKey&&K!==null){const m=[K,n].sort((p,G)=>p-G),g=S.slice(m[0],m[1]+1).map(p=>p.id),x=g.every(p=>I.includes(p));N(x?p=>p.filter(G=>!g.includes(G)):p=>Array.from(new Set([...p,...g])))}else ye(t)?(N(m=>m.includes(r)?m.filter(g=>g!==r):[...m,r]),a(n)):(I.includes(r)?N([]):N([r]),a(n))},[S,K,I]),xe=i.useCallback((t,r)=>{s[r].entryType!==null&&X({name:s[r].name,id:r,mode:"edit",tool:s[r].entryType,tabId:B(),scroll:0,preventSplit:!1,activate:!0,side:"left",tabType:"glossary",glossaryId:f??void 0})},[s,X,f]),ve=({id:t,offset:r})=>{var ie;if(f===null)return null;const n=D(Pe(f,t));if(!n)return null;const{expanded:m,rename:g}=D(He(f,t)),[x,p]=i.useState(n.name),[G,oe]=i.useState(m),je=d=>{d.preventDefault(),Z.current=setTimeout(()=>{ge(d,n.id,fe[n.id])},200)},Te=d=>{d.preventDefault(),Z.current&&clearTimeout(Z.current),xe(d,n.id)};i.useEffect(()=>{g&&R.current&&requestAnimationFrame(()=>{R.current!==null&&(R.current.focus(),R.current.select())})},[g]),i.useEffect(()=>{oe(m)},[m]);const De=()=>{oe(d=>!d),j(Oe({glossaryId:f,nodeId:n.id,expanded:!G}))},P=(d,Se,Ce)=>{p(d),re(Se),j(ce({glossaryId:f,nodeId:Ce}))};return e.jsxs(O,{className:"glossary-node-item",sx:{pl:2,ml:r*2,display:"grid",cursor:"pointer",gridTemplateColumns:"24px 24px auto",alignItems:"center",minHeight:"36px","&:hover":{backgroundColor:J},backgroundColor:((ie=l==null?void 0:l.node)==null?void 0:ie.id)===t||I.includes(t)?J:"transparent"},onContextMenu:d=>{d.preventDefault(),me(d,n)},children:[n.fileType==="section"&&e.jsx(L,{onClick:De,size:"small",sx:{zIndex:3},children:G?e.jsx(Le,{}):e.jsx(Qe,{})}),n.fileType==="detail"&&e.jsx(O,{sx:{width:"24px"}}),n.fileType==="section"&&!te.includes(n.entryType)?e.jsx(Y,{sx:{color:"primary.main"}}):n.entryType!==null?ee[n.entryType]:null,g?e.jsx(Ve,{inputRef:R,variant:"standard",value:x,onBlur:d=>{if(x.trim()===""){P(n.name,null,n.id);return}P(x,null,n.id),u({...n,name:x})},onChange:d=>p(d.target.value),onKeyDown:d=>{if(d.key==="Enter"){if(x.trim()===""){P(n.name,null,n.id);return}P(x,null,n.id),u({...n,name:x})}else d.key==="Escape"&&P(n.name,null,n.id)}}):e.jsx(V,{role:"button",tabIndex:0,sx:{ml:1,textAlign:"left",width:"100%",cursor:"pointer",userSelect:"none",fontSize:"0.875rem"},onClick:je,onDoubleClick:Te,children:n.name})]})},E=["person","note","event","location"],ae={continent:["territory","domain","province","landmark","settlement","faction",...E],territory:["domain","province","landmark","settlement","faction",...E],nation:["province","landmark","settlement","faction",...E],province:["landmark","settlement","faction",...E],landmark:["settlement","faction",...E],settlement:["faction",,...E],faction:[...E]};return e.jsxs(O,{children:[e.jsxs(Ne,{variant:"text",sx:{mb:.33},children:[e.jsx(_,{title:e.jsx(V,{children:"Add New Section"}),children:e.jsx("span",{children:e.jsx(L,{disabled:!f,onClick:t=>F(t.currentTarget),size:"small",children:e.jsx(Ze,{})})})}),e.jsx(_,{title:e.jsx(V,{children:"Add New Detail"}),children:e.jsx("span",{children:e.jsx(L,{disabled:!f,onClick:t=>z(t.currentTarget),size:"small",children:e.jsx($e,{})})})}),e.jsx(_,{title:e.jsx(V,{children:"Sort"}),children:e.jsx(L,{size:"small",children:e.jsx(tt,{})})})]}),S&&S.map(t=>{const r=s[t.id];return r?e.jsx(Ge,{type:r!=null&&r.entryType&&(r==null?void 0:r.entryType)in ae?ae[r.entryType].filter(n=>typeof n=="string").filter(n=>n!==void 0):[],handleAdd:()=>{},draggedType:T,endDrag:k,styleType:"glossary",bg2:"success.main",onReorder:()=>{},children:e.jsx(we,{type:r.entryType??"",item:r,startDrag:M,endDrag:k,children:e.jsx(ve,{id:r.id,offset:t.depth},r.id)})},t.id):null}),e.jsx($,{open:!!l,onClose:A,anchorReference:"anchorPosition",anchorPosition:l?{top:l.mouseY,left:l.mouseX}:void 0,children:(l==null?void 0:l.node)&&e.jsxs(e.Fragment,{children:[e.jsxs(C,{onClick:t=>{t.preventDefault(),l.node&&X({name:l.node.name,id:l.node.id,mode:"edit",tool:l.node.entryType,tabId:B(),scroll:0,preventSplit:!1,activate:!0,side:"left",tabType:"glossary",glossaryId:f??void 0}),A()},sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(et,{}),"Open"]}),e.jsxs(C,{onClick:t=>{re(l.node),A()},sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(ze,{}),"Rename"]}),e.jsxs(C,{onClick:t=>{if(t.preventDefault(),I.length>1){c(I.map(r=>Me.find(s,n=>n.id===r)).filter(r=>r!==void 0)),A();return}l.node&&(y(l.node),A())},sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Fe,{}),"Delete"]}),l.node.fileType==="section"&&e.jsxs(e.Fragment,{children:[e.jsxs(C,{onClick:t=>{t.preventDefault(),z(t.currentTarget)},sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(_e,{}),"New Detail"]}),l.node.entryType!=="faction"&&e.jsxs(C,{onClick:t=>{t.preventDefault(),F(t.currentTarget)},sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Y,{}),"New Section"]})]}),e.jsx(C,{onClick:t=>{t.preventDefault(),l.node&&console.log(Xe({node:l.node,nodeStructure:s}))},children:"Print Lineage Names"})]})}),e.jsx($,{anchorEl:U,open:!!U,onClose:()=>z(null),anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"left"},children:Re.map(t=>e.jsxs(C,{onClick:r=>{var n;r.preventDefault(),h({id:B(),parentId:((n=l==null?void 0:l.node)==null?void 0:n.id)||null,entryType:t}),A()},sx:{display:"flex",alignItems:"center",gap:2},children:[ee[t]||e.jsx(Y,{sx:{color:"primary.main"}}),de({glossary:le,key:t})]},t))}),e.jsx($,{anchorEl:W,open:!!W,onClose:()=>F(null),anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"left"},children:te.map((t,r)=>{var m,g;const n=te.indexOf(((m=l==null?void 0:l.node)==null?void 0:m.entryType)||"");return l!==null&&(n===-1||(g=l==null?void 0:l.node)!=null&&g.fileType&&l.node.fileType!=="section"||r<=n)?null:e.jsxs(C,{onClick:x=>{var p;x.preventDefault(),v({id:B(),name:"Untitled",parentId:((p=l==null?void 0:l.node)==null?void 0:p.id)||null,entryType:t}),A()},sx:{display:"flex",alignItems:"center",justifyContent:"start",gap:4},children:[ee[t]||e.jsx(Y,{sx:{color:"primary.main"}}),de({glossary:le,key:t})]},t)})})]})},ot=()=>{const o=ue(),s=D(pe()),u=D(Ke()),y=u.find(a=>a.id===s),[c,h]=i.useState(y||null),{roots:v,nodeMap:j}=D(Be(s||"")),l=D(Ye(s||"")),{showModal:w}=Ue();return i.useEffect(()=>{o(H.getGlossaries())},[]),i.useEffect(()=>{if(u.length>0&&s===null){const a=localStorage.getItem("lastActiveGlossaryId");a&&o(ne({glossaryId:a}))}},[u,s]),i.useEffect(()=>{if(u.length===0&&c!==null)h(null);else if(s!==null){const a=u.find(T=>T.id===s);a&&(c==null?void 0:c.id)!==a.id&&h(a)}},[s,u]),i.useEffect(()=>{s!==null&&l.length===0&&o(H.getNodes({glossaryId:s}))},[s]),{handleSelect:a=>{a!==s&&(o(ne({glossaryId:a})),h(a))},handleAddFolder:({id:a,name:T,parentId:k,entryType:M})=>{if(!s)return;const se={id:a,name:T,fileType:"section",parentId:k,glossaryId:s,entryType:M,children:[]};o(H.createNodeAndSection({node:se}))},handleDelete:a=>{if(a===null||s===null)return;w({entry:{componentKey:"ConfirmDeleteEntry",props:{node:a,glossaryId:s},id:"confirm-delete-entry"}})},handleMultipleDelete:a=>{if(a.length===0||s===null)return;w({entry:{componentKey:"ConfirmMultipleDeleteEntries",props:{nodes:a,glossaryId:s},id:"confirm-multiple-delete-entries"}})},handleRename:a=>{a!==null&&s!==null&&(console.log("updating names...",a),o(H.renameNodeAndEntry({node:a})))},handleAddEntry:({id:a,parentId:T,entryType:k})=>{if(k===null||s===null)return;const M={id:a,name:"Untitled",entryType:k,fileType:"detail",parentId:T,glossaryId:s};o(H.createNodeAndDetail({node:M}))},deselectGlossary:()=>{s!==null&&(o(We({config:"glossary",key:"activeTab",value:"Overview"})),h(null),o(ne({glossaryId:null})),localStorage.removeItem("lastActiveGlossaryId"))},glossary:c,roots:v,nodeMap:j}},ht=()=>{const{handleAddFolder:o,handleDelete:s,handleMultipleDelete:u,handleRename:y,handleAddEntry:c,deselectGlossary:h,glossary:v,roots:j,nodeMap:l}=ot();return e.jsx(qe,{children:e.jsxs(O,{sx:{height:"100vh"},children:[e.jsxs(O,{sx:{width:"100%",display:"flex",justifyContent:"center",position:"relative"},children:[e.jsx(L,{sx:{position:"absolute",left:0,top:"50%",transform:"translateY(-50%)"},onClick:h,children:e.jsx(Je,{})}),e.jsx(V,{variant:"h6",sx:{marginLeft:2},children:v&&v.name})]}),e.jsx(st,{children:e.jsx(at,{structure:j,nodeMap:l,onRename:y,onDelete:s,onMultipleDelete:u,onNewFile:c,onNewFolder:o})})]})})};export{ht as default};
