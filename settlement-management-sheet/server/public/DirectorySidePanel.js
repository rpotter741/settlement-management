import{H as B,j as n,a9 as De,r as i,a2 as pe,aa as ke,ab as Ee,ac as we,a3 as Ne,ad as Ae,ae as he,af as fe,ag as J,B as K,ah as R,ai as Ge,n as ge,aj as ze,ak as ae,J as X,al as Fe,O as ye,v as V,T as q,am as Re,an as me,a1 as xe,ao as Le,ap as ve,aq as Me,ar as Pe,as as Oe,a4 as Ve,I as se,a as ie,at as re,V as F,N as Be,K as He,au as Ke,av as _e,aw as ce,ax as Ue,ay as Ye,az as Xe,u as qe,aA as Y,aB as le,aC as Je,aD as de,aE as We,a6 as Qe}from"./main.js";import{G as Ze}from"./GlossarySidePanelWrapper.js";import"./useGlossaryManager.js";const $e=B(n.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}),"ChevronRight"),en=B(n.jsx("path",{d:"M20 6h-8l-2-2H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2m-1 8h-3v3h-2v-3h-3v-2h3V9h2v3h3z"}),"CreateNewFolder"),oe=B(n.jsx("path",{d:"M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8z"}),"Folder"),nn=B(n.jsx("path",{d:"M4.01 2 4 22h16V8l-6-6zM13 9V3.5L18.5 9z"}),"InsertDriveFileSharp"),tn=B(n.jsx("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8zm2 14h-3v3h-2v-3H8v-2h3v-3h2v3h3zm-3-7V3.5L18.5 9z"}),"NoteAdd"),sn=B(n.jsx("path",{d:"M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3z"}),"OpenInNew"),rn=B(n.jsx("path",{d:"M3 18h6v-2H3zM3 6v2h18V6zm0 7h12v-2H3z"}),"Sort");function ln({tree:r,renderState:e}){if(!r.length)return[];const u=[],o=(c,f)=>{var g;u.push({id:c.id,depth:f}),c.fileType==="section"&&((g=e[c.id])!=null&&g.expanded)&&c.children&&c.children.forEach(p=>{o(p,f+1)})};return r.forEach(c=>{o(c,0)}),u}const je=i.createContext({isDragging:!1,draggedType:null,draggedItem:null,startDrag:()=>{},endDrag:()=>{},lastDragged:null}),on=({children:r})=>{const e=De();return n.jsx(je.Provider,{value:e,children:r})},an=()=>{const r=i.useContext(je);if(!r)throw new Error("useGlossaryDrag must be used within a GlossaryDragProvider");return r};function Se({glossaryId:r,nodes:e,newParentId:u}){return async(o,c)=>{if(e.length===0||e.length===1&&e[0].parentId===u)return;const f=e.map(g=>pe.cloneDeep(ke(r,g.id)(c())));try{o(Ee({glossaryId:r,movedNodes:e,newParentId:u}));const g=e.map(p=>p.id);await we({ids:g,parentId:u})}catch(g){console.error("Error assigning new parent node:",g),o(Ne({message:"Failed to reparent nodes. Please try again.",type:"error"})),f.forEach(p=>{o(Ae({glossaryId:r,nodeId:p.id,nodeData:p}))})}}}const cn=({id:r,data:e,offset:u,glossaryId:o,clickTimeout:c,singleClick:f,idToIndex:g,doubleClick:p,inputRef:s,setRenameTarget:x,contextMenu:k,handleContextMenu:E,softHighlight:b,selected:L,onRename:I,hoverId:A,setHoverId:M})=>{var U;if(o===null)return null;const{expanded:l,rename:v}=R(Ge(o,r)),[y,w]=i.useState(e.name),[P,T]=i.useState(l),{addNewTab:j}=ge(),G=d=>{d.preventDefault(),c.current=setTimeout(()=>{f(d,e.id,g[e.id])},200)},H=d=>{d.preventDefault(),c.current&&clearTimeout(c.current),p(d,e.id)};i.useEffect(()=>{v&&s.current&&requestAnimationFrame(()=>{s.current!==null&&(s.current.focus(),s.current.select())})},[v]),i.useEffect(()=>{T(l)},[l]);const W=()=>{T(d=>!d),J(Re({glossaryId:o,nodeId:e.id,expanded:!P}))},h=(d,D,Z)=>{w(d),x(D),J(me({glossaryId:o,nodeId:Z}))},O=i.useMemo(()=>he[e.entryType]??[],[e.entryType]),_=i.useRef(null),[,C]=ze({type:e.entryType,item:{kind:"node",node:e},end:(d,D)=>{M(null)}}),[,Q]=fe({accept:O,hover:d=>{O.includes(d.node.entryType)&&M(e.id)},drop:d=>{O.includes(d.node.entryType)&&J(Se({glossaryId:o,nodes:[d.node],newParentId:e.id}))}});return C(Q(_)),n.jsxs(K,{className:"glossary-node-item",ref:_,sx:{pl:2,ml:u*2,display:"grid",cursor:"pointer",gridTemplateColumns:"24px 24px auto",alignItems:"center",minHeight:"32px",maxHeight:"32px","&:hover":{backgroundColor:b},backgroundColor:A===r?"success.main":((U=k==null?void 0:k.node)==null?void 0:U.id)===r||L.includes(r)?b:"transparent"},onContextMenu:d=>{d.preventDefault(),E(d,e)},children:[e.fileType==="section"&&n.jsx(X,{onClick:W,size:"small",sx:{zIndex:3},children:P?n.jsx(Fe,{}):n.jsx($e,{})}),e.fileType==="detail"&&n.jsx(K,{sx:{width:"24px"}}),ae[e.entryType],v?n.jsx(ye,{inputRef:s,variant:"standard",value:y,onBlur:d=>{if(y.trim()===""){h(e.name,null,e.id);return}e.name==="Untitled"&&j({name:y,id:e.id,mode:"edit",tool:e.entryType,tabId:V(),scroll:0,preventSplit:!1,activate:!0,side:"left",tabType:"glossary",glossaryId:o??void 0}),h(y,null,e.id),I({...e,name:y})},onChange:d=>w(d.target.value),onKeyDown:d=>{if(d.key==="Enter"){if(y.trim()===""){h(e.name,null,e.id);return}e.name==="Untitled"&&j({name:y,id:e.id,mode:"edit",tool:e.entryType,tabId:V(),scroll:0,preventSplit:!1,activate:!0,side:"left",tabType:"glossary",glossaryId:o??void 0}),h(y,null,e.id),I({...e,name:y})}else d.key==="Escape"&&h(e.name,null,e.id)}}):n.jsx(q,{role:"button",component:"div",tabIndex:0,sx:{ml:1,textAlign:"left",width:"100%",cursor:"pointer",userSelect:"none",fontSize:"0.875rem"},onClick:G,onDoubleClick:H,children:e.name})]})},ue=({setHoverId:r,hoverId:e,glossaryId:u,id:o})=>{const c=i.useRef(null),f=["continent",...he.continent],[,g]=fe({accept:f,hover:p=>{f.includes(p.node.entryType)&&r(o)},drop:p=>{f.includes(p.node.entryType)&&J(Se({glossaryId:u,nodes:[p.node],newParentId:null}))}});return g(c),n.jsx(K,{sx:{backgroundColor:e===o?"success.main":"transparent",height:"15px",minHeight:"5px",position:"relative"},ref:c})};async function be(r,e={},u){return window.__TAURI_INTERNALS__.invoke(r,e,u)}async function dn(r="robbiepottsdm"){try{const e=await be("get_glossaries",{userId:r});return console.log("Got glossaries:",e),e}catch(e){console.error("Failed to load glossaries:",e)}}async function un(){try{const r=V(),e=await be("create_glossary",{input:{id:r,name:"new Glossary",genre:"Fantasy",sub_genre:"Generic",description:"Im a description",created_by:"robbiepottsdm",content_type:"CUSTOM"}});return console.log(e),e}catch(r){console.log(r)}}const pn=({structure:r,nodeMap:e,onRename:u,onDelete:o,onMultipleDelete:c,onNewFile:f,onNewFolder:g})=>{const p=xe(),[s,x]=i.useState(null),[k,E]=i.useState(null),[b,L]=i.useState(null),[I,A]=i.useState([]),[M,l]=i.useState(null),{draggedType:v,endDrag:y,startDrag:w,draggedItem:P}=an(),{addNewTab:T}=ge(),j=Le(),H=((j==null?void 0:j.themeKey)??"light")==="dark"?"rgba(255,255,255,0.08)":"rgba(0,0,0,0.08)",W=i.useRef(null),h=R(ve());R(Me(h||""));const O=R(Pe(h)),{getPropertyLabel:_}=Oe(),C=i.useMemo(()=>!r||r.length===0||!O?[]:ln({tree:r,renderState:O??{}}),[r,O]),Q=i.useMemo(()=>{if(!C||C.length===0)return{};const t={};return C.forEach((a,m)=>{t[a.id]=m}),t},[C]),U=t=>{t&&h&&p(me({glossaryId:h,nodeId:t.id}))},d=(t,a)=>{t.preventDefault(),x({mouseX:t.clientX+2,mouseY:t.clientY-6,node:a})},D=()=>{x(null),E(null),L(null)},Z=i.useRef(null),Te=t=>t.metaKey||t.ctrlKey,Ie=i.useCallback((t,a,m)=>{if(t.shiftKey&&M!==null){const N=[M,m].sort((S,te)=>S-te),z=C.slice(N[0],N[1]+1).map(S=>S.id),ne=z.every(S=>I.includes(S));A(ne?S=>S.filter(te=>!z.includes(te)):S=>Array.from(new Set([...S,...z])))}else Te(t)?(A(N=>N.includes(a)?N.filter(z=>z!==a):[...N,a]),l(m)):(I.includes(a)?A([]):A([a]),l(m))},[C,M,I]),Ce=i.useCallback((t,a)=>{console.log("double click",a),e[a].entryType!==null&&(console.log("opening tab for",e[a].name),T({name:e[a].name,id:a,mode:"edit",tool:e[a].entryType,tabId:V(),scroll:0,preventSplit:!1,activate:!0,side:"left",tabType:"glossary",glossaryId:h??void 0}))},[e,T,h]),[$,ee]=i.useState(null);return n.jsxs(K,{children:[n.jsxs(Ve,{variant:"text",sx:{mb:.33},children:[n.jsx(se,{title:n.jsx(q,{children:"Add New Section"}),children:n.jsx("span",{children:n.jsx(X,{disabled:!h,onClick:t=>L(t.currentTarget),size:"small",children:n.jsx(en,{})})})}),n.jsx(se,{title:n.jsx(q,{children:"Add New Detail"}),children:n.jsx("span",{children:n.jsx(X,{disabled:!h,onClick:t=>E(t.currentTarget),size:"small",children:n.jsx(tn,{})})})}),n.jsx(se,{title:n.jsx(q,{children:"Sort"}),children:n.jsx(X,{size:"small",children:n.jsx(rn,{})})})]}),n.jsx(ie,{onClick:()=>h?dn("robbiepottsdm"):null,children:"tauri test"}),n.jsx(ie,{onClick:()=>h?un():null,children:"add new glossary"}),n.jsx(ue,{setHoverId:ee,hoverId:$,glossaryId:h||"",id:"root-top"}),C&&C.map(t=>{const a=e[t.id];return a?n.jsx(cn,{id:a.id,data:a,offset:t.depth,glossaryId:h,clickTimeout:Z,singleClick:Ie,idToIndex:Q,doubleClick:Ce,inputRef:W,setRenameTarget:U,contextMenu:s,handleContextMenu:d,softHighlight:H,selected:I,onRename:u,hoverId:$,setHoverId:ee},a.id):null}),n.jsx(ue,{setHoverId:ee,hoverId:$,glossaryId:h||"",id:"root-bottom"}),n.jsx(re,{open:!!s,onClose:D,anchorReference:"anchorPosition",anchorPosition:s?{top:s.mouseY,left:s.mouseX}:void 0,children:(s==null?void 0:s.node)&&n.jsxs(n.Fragment,{children:[n.jsxs(F,{onClick:t=>{t.preventDefault(),s.node&&T({name:s.node.name,id:s.node.id,mode:"edit",tool:s.node.entryType,tabId:V(),scroll:0,preventSplit:!1,activate:!0,side:"left",tabType:"glossary",glossaryId:h??void 0}),D()},sx:{display:"flex",alignItems:"center",gap:2},children:[n.jsx(sn,{}),"Open"]}),n.jsxs(F,{onClick:t=>{U(s.node),D()},sx:{display:"flex",alignItems:"center",gap:2},children:[n.jsx(Be,{}),"Rename"]}),n.jsxs(F,{onClick:t=>{if(t.preventDefault(),I.length>1){c(I.map(a=>pe.find(e,m=>m.id===a)).filter(a=>a!==void 0)),D();return}s.node&&(o(s.node),D())},sx:{display:"flex",alignItems:"center",gap:2},children:[n.jsx(He,{}),"Delete"]}),s.node.fileType==="section"&&n.jsxs(n.Fragment,{children:[n.jsxs(F,{onClick:t=>{t.preventDefault(),E(t.currentTarget)},sx:{display:"flex",alignItems:"center",gap:2},children:[n.jsx(nn,{}),"New Detail"]}),s.node.entryType!=="collective"&&n.jsxs(F,{onClick:t=>{t.preventDefault(),L(t.currentTarget)},sx:{display:"flex",alignItems:"center",gap:2},children:[n.jsx(oe,{}),"New Section"]})]}),n.jsx(F,{onClick:t=>{t.preventDefault(),s.node&&console.log(Ke({node:s.node,nodeStructure:e}))},children:"Print Lineage Names"})]})}),n.jsx(re,{anchorEl:k,open:!!k,onClose:()=>E(null),anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"left"},children:_e.map(t=>n.jsxs(F,{onClick:a=>{var m;a.preventDefault(),f({id:V(),parentId:((m=s==null?void 0:s.node)==null?void 0:m.id)||null,entryType:t}),D()},sx:{display:"flex",alignItems:"center",gap:2},children:[ae[t]||n.jsx(oe,{sx:{color:"primary.main"}}),_(t).label]},t))}),n.jsx(re,{anchorEl:b,open:!!b,onClose:()=>L(null),anchorOrigin:{vertical:"top",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"left"},children:ce.map((t,a)=>{var N,z;const m=ce.indexOf(((N=s==null?void 0:s.node)==null?void 0:N.entryType)||"");return s!==null&&(m===-1||(z=s==null?void 0:s.node)!=null&&z.fileType&&s.node.fileType!=="section"||a<=m)?null:n.jsxs(F,{onClick:ne=>{var S;ne.preventDefault(),g({id:V(),name:"Untitled",parentId:((S=s==null?void 0:s.node)==null?void 0:S.id)||null,entryType:t}),D()},sx:{display:"flex",alignItems:"center",justifyContent:"start",gap:4},children:[ae[t]||n.jsx(oe,{sx:{color:"primary.main"}}),_(t).label]},t)})})]})},hn=()=>{const r=xe(),e=R(ve()),u=R(Ue()),o=u.find(l=>l.id===e),[c,f]=i.useState(o||null),{roots:g,nodeMap:p}=R(Ye(e||"")),s=R(Xe(e||"")),{showModal:x}=qe();return i.useEffect(()=>{r(Y.getGlossaries())},[]),i.useEffect(()=>{if(u.length>0&&e===null){const l=localStorage.getItem("lastActiveGlossaryId");l&&r(le({glossaryId:l}))}},[u,e]),i.useEffect(()=>{if(u.length===0&&c!==null)f(null);else if(e!==null){const l=u.find(v=>v.id===e);l&&(c==null?void 0:c.id)!==l.id&&f(l)}},[e,u]),i.useEffect(()=>{e!==null&&s.length===0&&r(Y.getNodes({glossaryId:e}))},[e]),{handleSelect:l=>{l!==e&&(r(le({glossaryId:l})),f(l))},handleAddFolder:({id:l,name:v,parentId:y,entryType:w})=>{var j,G,H;if(!e||!o)return;const P=((H=(G=(j=o==null?void 0:o.integrationState)==null?void 0:j.system)==null?void 0:G[w])==null?void 0:H.default)||de[w],T={id:l,name:v,fileType:"section",parentId:y,glossaryId:e,entryType:w,children:[],subTypeId:P};r(Y.createNodeAndEntryThunk({node:T}))},handleDelete:l=>{if(l===null||e===null)return;x({entry:{componentKey:"ConfirmDeleteEntry",props:{node:l,glossaryId:e},id:"confirm-delete-entry"}})},handleMultipleDelete:l=>{if(l.length===0||e===null)return;x({entry:{componentKey:"ConfirmMultipleDeleteEntries",props:{nodes:l,glossaryId:e},id:"confirm-multiple-delete-entries"}})},handleRename:l=>{l!==null&&e!==null&&r(Y.renameNodeAndEntry({node:l}))},handleAddEntry:({id:l,parentId:v,entryType:y})=>{var T,j,G;if(!y||!e||!o)return;const w=((G=(j=(T=o==null?void 0:o.integrationState)==null?void 0:T.system)==null?void 0:j[y])==null?void 0:G.default)||de[y],P={id:l,name:"Untitled",entryType:y,fileType:"detail",parentId:v,glossaryId:e,subTypeId:w};r(Y.createNodeAndEntryThunk({node:P}))},deselectGlossary:()=>{e!==null&&(r(Je({config:"glossary",key:"activeTab",value:"Overview"})),f(null),r(le({glossaryId:null})),localStorage.removeItem("lastActiveGlossaryId"))},glossary:c,roots:g,nodeMap:p}},mn=()=>{const{handleAddFolder:r,handleDelete:e,handleMultipleDelete:u,handleRename:o,handleAddEntry:c,deselectGlossary:f,glossary:g,roots:p,nodeMap:s}=hn(),[x,k]=i.useState(""),E=i.useMemo(()=>x?Object.values(s).filter(b=>b.name.toLowerCase().includes(x.toLowerCase())):p,[s,p,x]);return n.jsx(Ze,{children:n.jsxs(K,{sx:{height:"100vh"},children:[n.jsxs(K,{sx:{width:"100%",display:"flex",justifyContent:"center",position:"relative"},children:[n.jsx(X,{sx:{position:"absolute",left:0,top:"50%",transform:"translateY(-50%)"},onClick:f,children:n.jsx(We,{})}),n.jsx(q,{variant:"h6",sx:{marginLeft:2},children:g&&g.name})]}),n.jsx(ye,{variant:"outlined",placeholder:"Search...",size:"small",sx:{py:2,width:"100%"},slotProps:{input:{startAdornment:n.jsx(Qe,{sx:{mr:1}})}},value:x,onChange:b=>k(b.target.value)}),n.jsx(on,{children:n.jsx(pn,{structure:E,nodeMap:s,onRename:o,onDelete:e,onMultipleDelete:u,onNewFile:c,onNewFolder:r})})]})})};export{mn as default};
