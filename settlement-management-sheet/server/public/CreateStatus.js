import{Z as D,Y as H,v as h,b4 as k,j as e,i as o,r as i,h as L,a1 as O,T as w,I as Y,aE as Q,a4 as C,K as b,X as N,a6 as X,a7 as Z,bc as G,W as E}from"./main.js";import{u as I}from"./useTools.js";import{E as J}from"./EditNameDescription.js";import{T as z}from"./ToolSelect.js";import{C as U}from"./CreateToolShell.js";import"./toolSelectors.js";import"./loadTool.js";import"./ToolInput.js";function _({tool:s,refId:r,id:t}){return D.prefetchQuery({queryKey:[s,t],queryFn:async()=>await H.getItem({tool:s,refId:r,id:t})}).then(()=>D.getQueryData([s,t]))}function ee(){return{id:h(),refId:h(),version:1,name:"",description:"",type:"Weather",mode:"Simple",steps:[{id:h(),name:"",description:"",impacts:[{system:null,target:null,key:null,value:null}]},{id:h(),name:"",description:"",impacts:[{system:null,target:null,key:null,value:null}]},{id:h(),name:"",description:"",impacts:[{system:null,target:null,key:null,value:null}]},{id:h(),name:"",description:"",impacts:[{system:null,target:null,key:null,value:null}]},{id:h(),name:"",description:"",impacts:[{system:null,target:null,key:null,value:null}]}],isValid:!1,status:"DRAFT",createdBy:""}}const te={name:{name:"name",label:"Status Name",type:"text",tooltip:"The unique name of the status. This should clearly convey the status's shape or meaning within the system mechanics",validate:s=>s?s.length<3?"Status name must be at least 3 characters long":null:"Status name is required",keypath:"name"},description:{name:"description",label:"Description",type:"text",tooltip:"A brief description of the status and its impact on system mechanics.",multiline:!0,minRows:3,validate:s=>s?s.length<30?`Description must be at least 30 characters. You have ${30-s.length} characters remaining.`:null:"Description is required",keypath:"description"}},se=()=>{const{tool:s,id:r}=k();return I(s,r),e.jsxs(o,{sx:{gridColumn:"span 3",width:"100%",display:"flex",alignItems:"center",gap:2},children:[e.jsx(z,{label:"Status Type",options:["Weather","Morale","Settlement"],keypath:"type"}),e.jsx(z,{label:"Creation Mode",keypath:"mode",options:["Simple","Advanced"]})]})},F=(s=[],r)=>Array.isArray(s)?[...s].sort((t,d)=>{const p=t[r],y=d[r];return p==null||y==null?0:typeof p=="number"&&typeof y=="number"?p-y:String(p).localeCompare(String(y),void 0,{sensitivity:"base"})}):[],ae={system:[{name:"None",value:""},{name:"Abstract Progress Tracker",value:"apt"},{name:"Attribute",value:"attribute"},{name:"Building",value:"building"},{name:"Category",value:"category"},{name:"Settlement",value:"settlement"}]},ne={attribute:[{name:"Current",value:"current"},{name:"Max",value:"max"},{name:"Bonus",value:"bonus"}],category:[{name:"Bonus",value:"bonus"},{name:"Add New Attribute",value:"addAttr"},{name:"Remove Attribute",value:"removeAttr"}],building:["Health","Durability","Complexity"],settlement:["Productivity","Supplies","Health","Vault","Settlement Points"]},B=({disabled:s=!1,index:r,keypath:t,onRemove:d=()=>{},isAdvanced:p=!1})=>{const{tool:y,id:v}=k(),{edit:S,updateTool:u}=I(y,v),[x,l]=i.useState(0),{options:c}=L(),[g,re]=i.useState(ae.system),[q,M]=i.useState([]),[P,R]=i.useState([]),[ue,ce]=i.useState([]),[V,K]=i.useState(""),[T,W]=i.useState(!1),n=O.get(S,t);return i.useEffect(()=>{var a;if(((a=n.system)==null?void 0:a.name)!==void 0){R(F(O.get(c,n.system.value,[]),"name"));const m=F(ne[n.system.value],"name");M(m)}},[c,n.system]),i.useEffect(()=>{u(`${t}.target`,null)},[n.system]),i.useEffect(()=>{u(`${t}.key`,null)},[n.target]),i.useEffect(()=>{u(`${t}.value`,null)},[n.key]),i.useEffect(()=>{(async()=>{var A,$;const m=n.system,j=n.target;if(m&&j)switch(m.value){case"attribute":try{const f=await _({tool:"attribute",id:(A=j.id)==null?void 0:A[0],refId:($=j.refId)==null?void 0:$[0]});f&&K(`${f.name} max per level is ${f.balance.maxPerLevel}`)}catch(f){console.error("Failed to fetch attribute:",f)}break}})()},[n.system,n.target]),e.jsxs(o,{sx:{width:"100%",display:"flex",alignItems:"start",justifyContent:"space-around",my:1,borderRadius:2,backgroundColor:"background.default",p:1,boxShadow:2,borderColor:"accent.light",boxSizing:"border-box",flexWrap:"wrap",pb:p?0:4},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",justifyContent:"center",position:"relative",width:"100%",height:48,mb:1},children:[e.jsx(w,{children:V}),e.jsx(Y,{sx:{position:"absolute",top:0,right:0,color:"warning.main"},onClick:d,children:e.jsx(Q,{})})]}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",justifyContent:"start",width:"50%"},children:[e.jsx(C,{value:n.system||{name:"-Select-",value:""},label:"System",onChange:(a,m)=>{u(`${t}.system`,m)},disabled:s,options:g,getOptionLabel:a=>a.name,renderInput:a=>e.jsx(b,{...a,label:"System",variant:"outlined",size:"small"}),sx:{width:"100%"}}),e.jsx(C,{value:n.target||{name:"-Select-",value:""},onChange:(a,m)=>{u(`${t}.target`,m),l(x+1)},disabled:n.system===null,options:P,getOptionLabel:a=>a.name,renderInput:a=>e.jsx(b,{...a,label:"Target",variant:"outlined",size:"small"}),sx:{width:"100%"}})]}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",justifyContent:"start",width:"50%"},children:[e.jsx(C,{value:n.key||{name:"-Select-",value:""},onChange:(a,m)=>{u(`${t}.key`,m)},disabled:n.target===null,options:q,getOptionLabel:a=>a.name,renderInput:a=>e.jsx(b,{...a,label:"Key",variant:"outlined",size:"small"}),sx:{width:"100%"}}),e.jsx(b,{value:n.value||0,onChange:a=>{u(`${t}.value`,Number(a.target.value))},disabled:n.key===null,label:"Value",variant:"outlined",size:"small",sx:{width:"100%"},type:"number"})]}),p&&e.jsxs(e.Fragment,{children:[e.jsx(N,{flexItem:!0,sx:{width:"100%"},children:e.jsx(X,{label:"Advanced",onClick:()=>{W(!T)},sx:{my:2,cursor:"pointer"}})}),e.jsx(Z,{in:T,timeout:"auto",unmountOnExit:!0,children:e.jsx(o,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",width:"100%",my:2}})})]})]})},ie=({})=>{const{tool:s,id:r}=k(),{edit:t,updateTool:d}=I(s,r),[p,y]=i.useState(!1),[v,S]=i.useState([!1,!1,!1,!1,!1]),u=(x,l)=>{const c=[...x];c.push({system:"",key:"",target:"",value:"add"}),d(`steps.${l}.impacts`,c)};return e.jsxs(o,{sx:{display:"grid",gridTemplateColumns:["1fr","1fr 1fr","repeat(3, 1fr)"],gridTemplateRows:"auto",alignItems:"start",justifyContent:"center",my:2,gap:2,backgroundColor:"background.paper",width:"100%",position:"relative",pb:2,overflowY:"auto",maxHeight:"calc(100vh - 200px)"},children:[e.jsx(J,{fields:te}),e.jsx(N,{sx:{gridColumn:"span 3"}}),e.jsx(se,{}),(t==null?void 0:t.mode)==="Advanced"?e.jsx(w,{sx:{gridColumn:"span 3"},children:"Advanced Creation Mode enables you to assign varying impacts to each step, allowing significantly more customization to the status that doesn't follow a linear progression, as well as giving you access to advanced customization logic."}):e.jsxs(w,{sx:{gridColumn:"span 3"},children:["Simple Creation Mode streamlines the status creation process by automatically scaling the Step 1 impacts to the rest of the steps. Simply put, a Step 1 Impact of Food (Current) - 1 will automatically result in a Step 2 Impact of Food (Current) - 2."," "]}),(t==null?void 0:t.mode)==="Advanced"&&e.jsx(o,{sx:{gridColumn:"span 3",display:"flex",gap:2,flexDirection:"column"},children:t.steps.map((x,l)=>e.jsxs(G,{title:`Step ${l+1}`,titleType:"h6",open:v[l],toggleOpen:()=>{const c=[...v];c[l]=!c[l],S(c)},children:[e.jsx(o,{sx:{display:"flex",flexDirection:"column"},className:"status-impacts",children:x.impacts.map((c,g)=>e.jsx(B,{index:g,keypath:`steps.${l}.impacts.${g}`,isAdvanced:t.mode==="Advanced"},g))}),e.jsx(E,{onClick:()=>{u(x.impacts,l)},children:"Add Impact"})]},l))}),(t==null?void 0:t.mode)==="Simple"&&e.jsxs(o,{sx:{gridColumn:"span 3",display:"flex",gap:2,flexDirection:"column"},children:[t.steps[0].impacts.map((x,l)=>e.jsx(B,{keypath:`steps.0.impacts.${l}`})),e.jsx(E,{onClick:()=>{u(entry.impacts,0)},children:"Add Impact"})]})]})},le=({id:s,mode:r,side:t,tabId:d})=>e.jsx(o,{children:"I'm preview status!"}),oe=[{keypath:"name",label:"Name"},{keypath:"description",label:"Description"}],ve=({tab:s})=>e.jsx(U,{tab:s,initializeTool:ee,validationFields:["name","description"],editComponent:ie,previewComponent:le,checklistContent:oe});export{ve as default};
