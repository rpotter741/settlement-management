import{F as K,j as e,v as $,r as j,a$ as Y,b0 as Q,W as X,G as S,T as g,b1 as Z,A as ee,b2 as te,b3 as ae,b4 as E,i as m,N as re,b5 as se,b6 as ne,a4 as le,K as ie,X as P,a6 as oe,R as ce,a0 as O,aP as U,b7 as de,aU as ue,I as V,a1 as N,b8 as z,aR as pe,Y as W,a2 as he,b9 as be,ba as me,bb as ve}from"./main.js";import{i as xe}from"./iconList.js";import{u as A}from"./useTools.js";import{T as I,I as fe}from"./ToolInput.js";import{T as ge}from"./ToolSelect.js";import{u as ye,O as Ce,R as q,P as Te}from"./ThresholdPreview.js";import{I as J}from"./Icon.js";import{A as je}from"./TagTable.js";import{C as we}from"./CreateToolShell.js";import"./toolSelectors.js";import"./loadTool.js";const ke=K(e.jsx("path",{d:"m12 4-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"}),"ArrowForward"),_=K(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 17h-2v-2h2zm2.07-7.75-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25"}),"Help"),Le=["Critical","Strained","Unstable","Stable","Improving","Strong","Thriving"];function Se(){const t=[9,29,49,69,84,99,100],s={data:{},order:[]};s.order=t.map((r,p)=>{const o=$();return s.data[o]={name:Le[p],max:r},o});const l={data:{},order:[]},c=$();return l.data[c]={name:"default",value:1},l.order=[c],{id:$(),refId:$(),version:0,name:"",description:"",icon:{...xe[0],color:"black",backgroundColor:"#fbf7ef"},balance:{cost:{base:0,perLevel:!0,valuePerLevel:1,interval:1,scaleToggle:!1,scaleCurve:"linear",valuesPerInterval:[]},max:{base:1,perLevel:!0,valuePerLevel:1,interval:1,scaleToggle:!1,scaleCurve:"linear",valuesPerInterval:[]},health:{base:0,perLevel:!1,valuePerLevel:0,interval:1,scaleToggle:!1,scaleCurve:"linear",valuesPerInterval:[]}},thresholds:s,settlementPointCost:l,isPositive:!0,canHurt:!0,isTradeable:!0,hasThresholds:!0,hasSPC:!0,genre:"",subGenre:"",properties:{data:{canOverflow:!0,isCurrency:!1,requiresUpkeep:!1,canGather:!1},config:{},order:["canOverflow","isCurrency","requiresUpkeep"]},tags:[],isValid:!1,status:"DRAFT",createdBy:""}}const D={name:{label:"Attribute Name",type:"text",tooltip:"The unique name of the attribute. This should clearly convey the attribute's purpose and role within the settlement mechanics.",validateFn:t=>t?t.trim().length<3?"Attribute name must be at least 3 characters long":null:"Attribute name is required",keypath:"name"},costPerLevel:{label:"Currency Cost",type:"number",tooltip:"The amount of currency required per level to acquire this attribute. This cost scales with the settlement's level.",validateFn:t=>t?t<=0?"Cost per level must be greater than 0":null:"Cost per level is required",keypath:"balance.cost.base"},healthPerLevel:{label:"Health Drain",type:"number",tooltip:"This value represents the health damage the settlement takes for each missing unit of this attribute, scaled by settlement level.",validateFn:t=>t==null?"Health per level is required":t<0?"Health per level cannot be negative":null,keypath:"balance.health.base"},maxPerLevel:{label:"Max",type:"number",tooltip:"The maximum number of units of this attribute that can provide benefits to the settlement per level.",validateFn:t=>t===void 0?"Max per level is required":t<0?"Max per level must be 0 or greater":null,keypath:"balance.max.base"},description:{label:"Description",type:"textarea",tooltip:"A brief explanation of the attribute's purpose and impact. This provides essential context for understanding its role in the settlement.",validateFn:t=>t?t.trim().length<30?`Description must be at least 30 characters long. You need ${30-t.length} more characters.`:null:"Description is required",keypath:"description"},healthValuePerLevel:{label:"Change Per Interval",type:"number",tooltip:"The scaling factor for health per level. This value represents the scaling value per interval based on Health Drain.",validateFn:t=>t==null?"Health per level scale is required":null,keypath:"balance.health.valuePerLevel"},healthIntervalPerLevel:{label:"Interval (Every N Levels)",type:"number",tooltip:"The interval at which health is calculated based on the health drain. This value determines how often the health is updated.",validateFn:t=>t==null?"Health interval per level is required":t<=0?"Health interval per level must be greater than 0":null,keypath:"balance.health.interval"},costValuePerLevel:{label:"Change Per Interval",type:"number",tooltip:"The scaling factor for cost per level. This value represents the scaling value per interval based on Cost.",validateFn:t=>t==null?"Cost per level scale is required":null,keypath:"balance.cost.valuePerLevel"},costIntervalPerLevel:{label:"Interval (Every N Levels)",type:"number",tooltip:"The interval at which cost is calculated based on the cost per level. This value determines how often the cost is updated.",validateFn:t=>t==null?"Cost interval per level is required":t<=0?"Cost interval per level must be greater than 0":null,keypath:"balance.cost.interval"},maxValuePerLevel:{label:"Change Per Interval",type:"number",tooltip:"The scaling factor for max per level. This value represents the scaling value per interval based on Max.",validateFn:t=>t==null?"Max per level scale is required":null,keypath:"balance.max.valuePerLevel"},maxIntervalPerLevel:{label:"Interval (Every N Levels)",type:"number",tooltip:"The interval at which max is calculated based on the max per level. This value determines how often the max is updated.",validateFn:t=>t==null?"Max interval per level is required":t<=0?"Max interval per level must be greater than 0":null,keypath:"balance.max.interval"}},k=({keypath:t,trueLabel:s="",falseLabel:l="",sx:c={display:"flex",alignItems:"center",justifyContent:"space-between",gap:1,boxSizing:"border-box",transition:"background-color 0.3s ease, border-color 1s ease",borderLeft:"2px solid",pl:2,py:.5,width:"100%",color:"text.primary",borderRadius:0},tooltip:r,disabled:p=!1,onChange:o,falseColor:a="warning",trueColor:v="success",trueThemeKey:x="main",falseThemeKey:n="main",border:b=!0,variant:d="row",buttonType:u="button",heightLock:i=!1})=>{const{tool:h,id:f}=j.useContext(Y),{updateTool:w,selectEditValue:y}=A(h,f),C=y(t),{utils:T}=Q(),F=()=>{w(t,!C),typeof o=="function"&&o(!C)};return e.jsxs(X,{tabIndex:-1,disableFocusRipple:!0,disabled:p,onClick:()=>{u==="button"&&F()},sx:{...c,borderColor:C?T.color(v,x,.5):T.color(a,n,.5),"&:hover":{bgcolor:C?T.color(v,x,.1):T.color(a,n,.1)},borderLeft:b?c==null?void 0:c.borderLeft:"none",flexDirection:d},children:[e.jsx(S,{title:e.jsx(g,{variant:"body2",children:r||`Toggle ${t}`}),placement:"top",arrow:!0,children:e.jsx(g,{variant:"body2",sx:{flexGrow:1,textAlign:"left",textTransform:"uppercase"},children:C?s:l||s})}),e.jsx(Z,{id:`${h}-${f}-${t}`,size:"small",color:C?v:a,checked:C===!0,sx:{"& .MuiSwitch-switchBase":{"&.Mui-checked":{color:T.color(v,x,.8)},"&:not(.Mui-checked)":{color:T.color(a,n,.8)}},"& .MuiSwitch-track":{backgroundColor:T.color("info","light",1)}},onClick:()=>{(u="switch")&&F()}})]})},Pe=te(ae.div)({}),G=({children:t,show:s=!0,duration:l=.3,sx:c={},onMouseLeave:r=()=>{},onMouseEnter:p=()=>{}})=>e.jsx(ee,{children:s&&e.jsx(Pe,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:l},style:{overflow:"hidden",marginBottom:"0.5rem"},sx:c,onMouseLeave:r,onMouseEnter:p,children:t})}),Ie={linear:"Change Per Interval","slow-exponential":"Base","fast-exponential":"Base",custom:"Change Per Interval"},R=({disabled:t,property:s,fields:l,borderColor:c="honey.main",accentColor:r="info.main"})=>{const{id:p,tool:o}=E(),{edit:a,updateTool:v,selectEditValue:x}=A(o,p),[n,b]=j.useState(!1),d=x(`balance.${s}`);if(!d)return null;const{interval:u,scaleCurve:i,valuesPerInterval:h}=d,f=()=>{const w=a.balance[s],{interval:y,scaleToggle:C,valuesPerInterval:T}=w;if(y<=0)return[];const F={};if(T.forEach(L=>{L&&L.level&&L.value!==void 0&&(F[L.level]=L.value)}),C){const L=Array.from({length:Math.ceil(21/y)},(M,H)=>H*y).slice(1,21).map(M=>({level:M,value:0}));v(`balance.${s}.valuesPerInterval`,L)}else return[]};return j.useEffect(()=>{i==="custom"&&f()},[i,u]),e.jsxs(G,{show:!t,sx:{gridColumn:"span 2",display:"grid",gridTemplateColumns:"5fr 1fr",alignItems:"center",border:"1px solid",borderColor:a!=null&&a.balance[s].perLevel?n?r:c:"transparent",transition:"border-color 0.3s ease, padding 0.3s ease",boxSizing:"border-box",p:a.balance[s].perLevel?1:0,borderRadius:2},onMouseEnter:b.bind(null,!0),onMouseLeave:b.bind(null,!1),children:[e.jsx(I,{inputConfig:l[`${s}PerLevel`]}),e.jsx(k,{keypath:`balance.${s}.perLevel`,trueLabel:"Scale",falseLabel:"Flat",tooltip:"Enable to automatically adjust related values when max per level changes.",border:!1,variant:"column-reverse",disabled:t,heightLock:!0}),e.jsxs(G,{show:a==null?void 0:a.balance[s].perLevel,sx:{gridColumn:"span 2",display:"grid",gridTemplateColumns:"5fr 1fr",alignItems:"center",justifyContent:"center"},children:[e.jsx(I,{inputConfig:l[`${s}IntervalPerLevel`],decimals:0,allowZero:!1}),e.jsx(k,{keypath:`balance.${s}.scaleToggle`,trueLabel:"Custom",falseLabel:"Default",variant:"column-reverse",tooltip:"Enable scaling separate from the base value.",border:!1,heightLock:!0}),e.jsxs(G,{show:a==null?void 0:a.balance[s].scaleToggle,sx:{gridColumn:"span 2",display:"grid",gridTemplateColumns:"1fr 1fr",gap:2,flexDirection:"column",width:"100%",alignItems:"center",justifyContent:"center"},children:[e.jsx(I,{dynamicLabel:Ie[a==null?void 0:a.balance[s].scaleCurve],inputConfig:l[`${s}ValuePerLevel`],style:{width:"100%"},disabled:(a==null?void 0:a.balance[s].scaleCurve)==="custom"}),e.jsx(ge,{keypath:`balance.${s}.scaleCurve`,label:"Scale Curve",options:[{value:"linear",name:"Linear"},{value:"slow-exponential",name:"Slow Exponential"},{value:"fast-exponential",name:"Fast Exponential"},{value:"custom",name:"Per Interval"}],small:!1}),e.jsx(G,{show:(a==null?void 0:a.balance[s].scaleCurve)==="custom",sx:{gridColumn:"span 2",display:"grid",gridTemplateColumns:["1fr","1fr 1fr","repeat(3, 1fr)","repeat(4, 1fr)","repeat(5, 1fr)"],gap:1,width:"100%"},children:h.map((w,y)=>e.jsx(I,{inputConfig:{keypath:`balance.${s}.valuesPerInterval.${y}.value`,label:`Level ${w.level}`,type:"number"},style:{width:"100%"}},`${s}-interval-${y}`))})]})]})]})},Ee=({columns:t})=>{const{tool:s,id:l}=j.useContext(Y),{edit:c}=A(s,l),[r,p]=j.useState(!1),[o,a]=j.useState(5),v=n=>{const b=c.balance[n],{base:d,perLevel:u,valuePerLevel:i,interval:h,scaleToggle:f}=b;return f?`Floor(${o} / ${h}) * ${i} + ${d})`:u?`Floor(${o} / ${h}) * ${d})`:`${d}`},x=n=>{const b=c.balance[n],{base:d,perLevel:u,valuePerLevel:i,interval:h,scaleToggle:f,scaleCurve:w,valuesPerInterval:y}=b;if(d===void 0)return"0";switch(f){case!0:{const C=o/h;switch(w){case"linear":return(Math.floor(C)*i+d).toFixed(0);case"slow-exponential":return(Math.pow(C,1.5)*i+d).toFixed(0);case"fast-exponential":return(Math.pow(C,2)*i+d).toFixed(0);case"custom":{if(!(y!=null&&y.length))return d.toFixed(0);const T=Math.floor(C);return T<0||T-1>=y.length?d.toFixed(0):(y.slice(0,T).reduce((M,H)=>M+H.value,0)+d).toFixed(0)}default:return d.toFixed(0)}}case!1:return u?(Math.max(1,Math.floor(o/h))*d).toFixed(0):d.toFixed(0);default:return d.toFixed(0)}};return c?e.jsxs(m,{id:`attr-values-${l}`,sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(re,{sx:{display:"flex",flexDirection:"row",alignItems:"center",gap:1,height:"100%"},children:[e.jsxs(se,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(g,{children:"Autobalance"}),e.jsx(S,{title:"Automatically adjust related values to maintain a balanced configuration.",children:e.jsx(fe,{sx:{fontSize:18,color:"text.secondary",cursor:"pointer"}})})]}),e.jsx(Z,{checked:r,onChange:n=>p(n.target.checked)})]}),e.jsxs(m,{sx:{display:"grid",gridTemplateColumns:"5fr 1fr",gridTemplateRows:"auto",alignItems:"center",justifyContent:"start",my:2,width:"100%",position:"relative",gridColumn:"span 3",boxSizing:"border-box"},children:[e.jsx(m,{sx:{gridColumn:"span 2",display:"flex",width:"100%",justifyContent:"center",alignItems:"center"},children:e.jsxs(m,{sx:{display:"flex",flexDirection:"column",width:"100%",boxSizing:"border-box",px:4},children:[e.jsx(ne,{valueLabelDisplay:"auto",color:"secondary",defaultValue:o,value:o,onChange:(n,b)=>{a(b)},min:1,max:20,step:1}),e.jsxs(m,{sx:{display:"flex",flexWrap:"wrap",alignItems:"center",justifyContent:"center",gap:1},children:[e.jsx(g,{variant:"body2",sx:{fontWeight:"bold",width:"100%"},children:`Values at Level ${o}: `}),e.jsx(S,{title:v("max"),children:e.jsxs(g,{variant:"body2",sx:{fontWeight:"bold",textDecoration:"underline",cursor:"help",color:"success.main"},children:["Max: ",x("max")]})}),c.canHurt&&e.jsx(S,{title:v("health"),children:e.jsxs(g,{variant:"body2",sx:{fontWeight:"bold",textDecoration:"underline",cursor:"help",color:"error.main"},children:["Health: ",x("health")]})}),c.isTradeable&&e.jsx(S,{title:v("cost"),children:e.jsxs(g,{variant:"body2",sx:{fontWeight:"bold",textDecoration:"underline",cursor:"help",color:"honey.main"},children:["Cost: ",x("cost")]})})]})]})}),e.jsx(R,{disabled:!1,property:"max",fields:D,slide:o,setSlide:a,slideLabel:"Max Value",borderColor:"dividerDark"}),e.jsx(R,{disabled:!c.canHurt,property:"health",fields:D,slide:o,setSlide:a,slideLabel:"Total Drain",borderColor:"dividerDark",accentColor:"error.main"}),e.jsx(R,{disabled:!c.isTradeable,property:"cost",fields:D,slide:o,setSlide:a,slideLabel:"Total Cost",borderColor:"dividerDark",accentColor:"honey.main"})]})]}):null},Ae={name:"",tooltip:"",type:"number",validate:t=>t<=-1?"Value must be 0 or greater":null,keypath:""},Fe=({content:t})=>e.jsx(g,{component:"span",children:t.map((s,l)=>s.type==="text"?e.jsx("span",{children:s.value},l):s.type==="strong"?e.jsx("strong",{children:s.value},l):s.type==="tooltip"?e.jsx(S,{title:s.title,arrow:!0,children:e.jsx(g,{component:"span",sx:{textDecoration:"underline",fontWeight:"bold",cursor:"pointer"},onClick:s.onClick,children:s.value})},l):null)}),De=[{name:"Fortified",description:"Fortified Settlements put their trust in theirs walls, preemptive reconnaissance, and well-trained troops.",id:"789"},{name:"Mercantile",description:"Mercantile Settlements focus on establishing and expanding trade, developing vibrant culture, and welcoming artisans.",id:"456"},{name:"Survivalist",description:"Survivalists focus on gathering food, supplies, medical items, and constructing durable shelters.",id:"123"}],Me=[{type:"text",value:"Define the "},{type:"tooltip",title:"Settlements earn 1 settlement point per level per turn, barring other boons or banes. Click for more information.",value:"Settlement Point Cost",onClick:()=>console.log("open SPC help panel")},{type:"text",value:" of this attribute per Settlement Type. A value of "},{type:"strong",value:"0"},{type:"text",value:" means this cannot be purchased with settlement points for that settlement type."}],$e=()=>{const{tool:t,id:s}=E(),{data:l,order:c,errors:r,add:p,remove:o}=ye(t,s,"settlementPointCost"),[a,v]=j.useState(null),[x,n]=j.useState(""),b=j.useMemo(()=>{const u=Object.keys(l||{}).reduce((h,f)=>(h.push(f),h),[]);return De.filter(h=>!u.includes(h.id))},[l]),d=j.useMemo(()=>Object.entries(l||{}).map(([u,i])=>{const h=i;return{...Ae,name:h.name,label:h.name.charAt(0).toUpperCase()+h.name.slice(1),tooltip:void 0,id:u,keypath:`settlementPointCost.data.${u}.value`}}),[l]);return c?e.jsxs(m,{sx:{display:"grid",gridTemplateColumns:"1fr 0.1fr 1fr",gap:2},children:[e.jsx(m,{sx:{gridColumn:"span 3",p:2},children:e.jsx(Fe,{content:Me})}),e.jsx(m,{sx:{display:"flex",alignItems:"start",width:"100%"},children:e.jsx(le,{inputValue:x,options:b,getOptionLabel:u=>u.name,renderInput:u=>e.jsx(ie,{...u,label:"Settlement Type",variant:"outlined",error:!!(r!=null&&r.name),helperText:r==null?void 0:r.name,onChange:i=>{n(i.target.value)},onKeyDown:i=>{i.key==="Enter"&&(p({id:a.id,entry:{name:a.name,value:1},sort:!1}),n(""))}}),onChange:(u,i)=>{v(i),n((i==null?void 0:i.name)||"")},renderOption:(u,i)=>j.createElement(m,{...u,component:"li",key:i.name,sx:{display:"flex",alignItems:"center"}},e.jsx(S,{title:e.jsx(g,{children:i.description}),placement:"left",arrow:!0,children:e.jsx(g,{children:i.name})})),sx:{my:2,width:"100%"}})}),e.jsx(P,{orientation:"vertical",flexItem:!0,children:e.jsx(oe,{label:e.jsx(ke,{}),onClick:()=>{p({id:a.id,entry:{name:a.name,value:1},sort:!1}),n("")},sx:{width:"100%",color:"white"}})}),e.jsx(m,{children:c.map((u,i)=>{const h=d.find(f=>f.id===u);return h?e.jsx(ce.Fragment,{children:e.jsx(I,{inputConfig:h,style:{width:"100%",m:0,p:0},shrink:!0,onMoreDetails:h.name!=="default"?()=>{console.log("More details clicked")}:void 0,onRemove:h.name!=="default"?()=>o(u):void 0})},u):null})})]}):e.jsx(m,{children:"Loading..."})},qe={propertiesExpanded:!0,editTabs:{Properties:{name:"Properties",disabled:!1},Values:{name:"Values",disabled:!1},SPC:{name:"SPC",disabled:!1},Thresholds:{name:"Thresholds",disabled:!1},Currency:{name:"Currency",disabled:!0},Gather:{name:"Gather",disabled:!0},Upkeep:{name:"Upkeep",disabled:!0}},activeTab:"Properties",lastTab:null,activeIndex:0,lastIndex:0};function Ge(t,s){switch(s.type){case"TOGGLE_PROPERTIES":return{...t,propertiesExpanded:!t.propertiesExpanded};case"SET_ACTIVE_TAB":const{name:l,index:c,defaultLast:r}=s.payload;return{...t,lastIndex:r?0:t.activeIndex,lastTab:r?"Values":t.activeTab,activeTab:l,activeIndex:c};case"SET_TAB_DISABLED":{const{property:p,disabled:o}=s.payload;return{...t,editTabs:{...t.editTabs,[p]:{...t.editTabs[p],disabled:o}}}}default:return t}}const B=(t,s,l)=>({type:"SET_ACTIVE_TAB",payload:{name:t,index:s,defaultLast:l}}),He=(t,s)=>({type:"SET_TAB_DISABLED",payload:{property:t,disabled:s}}),Re=({columns:t})=>{var v,x,n,b;const s=O(),{tool:l,id:c,showModal:r,tabId:p,side:o}=E(),{edit:a}=A(l,c);return j.useEffect(()=>{a!=null&&a.name&&(s(U({tabId:p,side:o,keypath:"name",updates:(a==null?void 0:a.name.trim().length)>0?a==null?void 0:a.name.trim():"Untitled"})),s(U({tabId:p,side:o,keypath:"viewState.isDirty",updates:!0})))},[a==null?void 0:a.name,s,p,o]),e.jsxs(e.Fragment,{children:[e.jsxs(m,{sx:{gridColumn:`span ${t}`,display:"flex",alignItems:"center",gap:2},children:[e.jsxs(m,{sx:{display:"flex",alignItems:"center",justifyContent:"space-around",flexGrow:1},children:[e.jsx(g,{variant:"h6",children:"Icon:"}),e.jsx(J,{viewBox:((v=a==null?void 0:a.icon)==null?void 0:v.viewBox)||"0 0 664 512",path:((x=a==null?void 0:a.icon)==null?void 0:x.d)||"",size:24,color:((n=a==null?void 0:a.icon)==null?void 0:n.color)||"primary",backgroundColor:((b=a==null?void 0:a.icon)==null?void 0:b.backgroundColor)||"background.paper",onClick:()=>{r({entry:{componentKey:"IconSelector",props:{tool:l,id:c,tabId:p,side:o},id:"icon-selector"}})}})]}),e.jsx(I,{inputConfig:D.name,style:{flexGrow:2,flexShrink:1,px:1}})]}),e.jsx(I,{inputConfig:D.description,style:{gridColumn:`span ${t}`,px:1},multiline:!0})]})},Ue={isTradeable:{disables:["properties.data.isCurrency"]},"properties.data.isCurrency":{disables:["properties.data.requiresUpkeep","isTradeable"],enables:["properties.data.canOverflow"]},"properties.data.requiresUpkeep":{disables:["properties.data.isCurrency","properties.data.canHarvest"]},"properties.data.canGather":{disables:["properties.data.requiresUpkeep"]}},Be={hasThresholds:{key:"Thresholds",value:!0},hasSPC:{key:"SPC",value:!0},"properties.data.isCurrency":{key:"Currency",value:!1},"properties.data.requiresUpkeep":{key:"Upkeep",value:!1},"properties.data.canGather":{key:"Gather",value:!1}},Oe=({columns:t,activeTab:s,lastTab:l,lastIndex:c,localDispatch:r})=>{const{tool:p,id:o,showModal:a,tabId:v,side:x}=E(),{edit:n,updateTool:b}=A(p,o),{makeSnackbar:d}=de(),u=(i,h)=>{var y,C;const f=Ue[i],w=Be[i];w&&(s===w.key&&!h&&r(B(l,c,!0)),r(He(w.key,!h))),f&&h&&((y=f.disables)==null||y.forEach(T=>{b(T,!1)}),f!=null&&f.enables&&((C=f==null?void 0:f.enables)==null||C.forEach(T=>{b(T,!0)})))};return n?e.jsxs(e.Fragment,{children:[e.jsx(Re,{columns:t}),e.jsx(m,{sx:{gridColumn:`span ${t}`},children:e.jsx(ue,{defaultGenre:n.genre,defaultSubGenre:n.subGenre,updateFn:b})}),e.jsxs(m,{sx:{gridColumn:`span ${t}`,display:"grid",gridTemplateColumns:["1fr","1fr",`repeat(${t}, 1fr)`],gap:2},children:[e.jsxs(m,{children:[e.jsxs(P,{children:["Major Properties"," ",e.jsx(V,{size:"small",children:e.jsx(_,{})})]}),e.jsx(k,{keypath:"isPositive",trueLabel:"Is Positive",falseLabel:"Is Negative",falseColor:"error",tooltip:"Toggle if this attribute is positive or negative. A positive attribute is beneficial, while a negative attribute is detrimental."}),e.jsx(k,{keypath:"canHurt",trueLabel:"Can Hurt",falseLabel:"Cannot Hurt",tooltip:"Toggle if this attribute can affect health."}),e.jsx(k,{keypath:"isTradeable",trueLabel:"Can Trade",falseLabel:"Cannot Trade",tooltip:"Toggle if this attribute can be traded. This forces a baseline cost, and allows it to be added to Trading Hubs. Tradeable attributes cannot be currency.",disabled:n==null?void 0:n.properties.data.isCurrency}),e.jsx(k,{keypath:"hasThresholds",trueLabel:"Thresholds",falseLabel:"No Thresholds",tooltip:"Toggle if this attribute has unique thresholds. If disabled, default thresholds will be used internally.",onChange:()=>{u("hasThresholds",!n.hasThresholds),n.hasThresholds&&d({message:"Default thresholds will be used.",type:"info",duration:3e3})}}),e.jsx(k,{keypath:"hasSPC",trueLabel:"Settlement Points",falseLabel:"No Settlement Points",tooltip:"Toggle if this attribute can be acquired through settlement points.",onChange:()=>{u("hasSPC",!n.hasSPC)}})]}),e.jsxs(m,{children:[e.jsxs(P,{children:["Minor Properties"," ",e.jsx(V,{size:"small",children:e.jsx(_,{})})]}),e.jsx(k,{keypath:"properties.data.canOverflow",trueLabel:"Can Overflow",falseLabel:"Cannot Overflow",tooltip:"Toggle if this attribute can overflow. Overflowing attributes can exceed their maximum value, but overages will not be counted towards calculations.",disabled:n==null?void 0:n.properties.data.isCurrency}),e.jsx(k,{keypath:"properties.data.isCurrency",trueLabel:"Is Currency",falseLabel:"Not Currency",tooltip:"Toggle if this attribute is treated as currency. This removes any cap on the attribute's value and allows it to integrate with the Tax System, among other things.",disabled:(n==null?void 0:n.isTradeable)||(n==null?void 0:n.properties.data.requiresUpkeep),onChange:i=>{u("properties.data.isCurrency",i),i&&n.properties.data.canGather&&d({message:"Currency attributes are rarely harvestable. Be sure this makes sense in your world!",type:"warning",duration:5e3})}}),e.jsx(k,{keypath:"properties.data.requiresUpkeep",trueLabel:"Requires Upkeep",falseLabel:"No Upkeep Required",tooltip:"Toggle if this attribute requires upkeep. This will add an upkeep cost to the attribute, which must be paid with a currency to keep it active.",disabled:(n==null?void 0:n.properties.data.isCurrency)||(n==null?void 0:n.properties.data.canGather),onChange:i=>{u("properties.data.requiresUpkeep",i)}}),e.jsx(k,{keypath:"properties.data.canGather",trueLabel:"Can Gather",falseLabel:"Cannot Gather",tooltip:"Toggle if this attribute can be acquired by assigning other attributes, e.g. 'Productivity', to it.",disabled:n==null?void 0:n.properties.data.requiresUpkeep,onChange:i=>{u("properties.data.canGather",i),i&&n.properties.data.isCurrency&&d({message:"Harvestable attributes are rarely currency. Be sure this makes sense in your world!",type:"warning",duration:5e3})}})]})]}),e.jsx(je,{})]}):null};function Ve({id:t,tool:s,tabId:l,side:c}){return async(r,p)=>{var n,b;const o=p(),a=N.cloneDeep(o.tools[s].edit.byId[t]),v=Object.keys(((b=(n=o.tabs[c].data[l])==null?void 0:n.viewState)==null?void 0:b.dirtyKeypaths)||{});if(v.length===0)return;const x={};v.forEach(d=>{const u=d.split(".").shift();x[u]=N.get(a,u)}),r(z({tool:s,id:t,updates:{...x,version:1}})),r(pe({tabId:l}));try{a.version===0?await W.saveTool({id:t,tool:s,data:{...a,version:1}}):await W.saveTool({id:t,tool:s,data:{...x}})}catch(d){console.error("Error during batch update:",d),r(he({message:`Failed to batch update ${a.name}. Please try again.`,type:"error",duration:5e3})),r(z({tool:s,id:t,updates:{...a}}))}}}function Ne({tool:t,id:s,tabId:l,side:c,name:r}){const p=O();return{name:r,batchSaveFn:async()=>{p(Ve({id:s,side:c,tabId:l,tool:t}))},intervalMs:6e4}}const ze={Properties:Oe,Values:Ee,SPC:$e,Thresholds:Ce,Currency:()=>e.jsx(m,{children:"Currency Component"}),Gather:()=>e.jsx(m,{children:"Gather Component"}),Upkeep:()=>e.jsx(m,{children:"Upkeep Component"})},We=()=>{const{tab:t,id:s}=E(),{both:l}=be(),c=O(),[r,p]=j.useReducer(Ge,t.viewState.editAttr||qe),{activeTab:o,editTabs:a,lastIndex:v}=r;me(Ne({name:t.name,tool:"attribute",id:s,tabId:t.tabId,side:t.side})),j.useEffect(()=>{t.lastTab&&t.lastIndex&&p(B(t.lastTab,t.lastIndex))},[]),j.useEffect(()=>()=>{c(U({tabId:t.tabId,side:t.side,keypath:"viewState.editAttr",updates:{...r}}))},[r]);const x=l?1:2,n=(b,d)=>{p(B(b,d))};return e.jsx(m,{id:`edit-attribute-${t.id}`,sx:{height:"100%",transition:"height 0.4s ease-in-out",overflow:"auto",width:"100%",px:2,boxSizing:"border-box"},children:e.jsx(ve,{tabs:Object.values(a).map(b=>({...b,disabled:b.disabled||!1,props:{localDispatch:p}})),componentMap:ze,activeTab:o,handleTabClick:n,columns:x,lastIndex:v})})},_e=()=>{var p,o,a,v,x,n,b,d,u,i;const{tool:t,id:s,mode:l,side:c}=E(),{current:r}=A("attribute",s);return e.jsxs(m,{sx:{display:"grid",gridTemplateColumns:["1fr","1fr 1fr","repeat(3, 1fr)"],gridTemplateRows:"auto",alignItems:"start",justifyContent:"center",mt:2,gap:2,width:"100%",position:"relative",pb:4},children:[e.jsxs(m,{sx:{display:"flex",alignItems:"center",justifyContent:"center",gap:1,height:"88px",flexGrow:1,flexShrink:2},children:[e.jsx(g,{variant:"body1",sx:{fontWeight:"bold",fontSize:"1.25rem"},children:"Icon"}),e.jsx(X,{sx:{boxShadow:4,borderRadius:"50%",height:64,width:64},disabled:!0,children:e.jsx(J,{viewBox:((p=r==null?void 0:r.icon)==null?void 0:p.viewBox)||"0 0 664 512",path:((o=r==null?void 0:r.icon)==null?void 0:o.d)||"",size:24,color:((a=r==null?void 0:r.icon)==null?void 0:a.color)||"primary",backgroundColor:((v=r==null?void 0:r.icon)==null?void 0:v.backgroundColor)||"background.paper"})})]}),e.jsxs(m,{sx:{gridColumn:"span 2",display:"flex",gap:2,alignItems:"center",justifyContent:"start",height:"100%"},children:[e.jsx(g,{variant:"h6",children:"Name:"}),e.jsx(g,{children:(r==null?void 0:r.name)||"None"})]}),e.jsx(P,{sx:{gridColumn:"span 3",borderColor:"#ccc",fontWeight:"bold"},children:"DESCRIPTION"}),e.jsxs(m,{sx:{gridColumn:"span 3",display:"flex",flexDirection:"column",gap:2,alignItems:"start",justifyContent:"center"},children:[e.jsx(g,{sx:{textAlign:"start"},variant:"body1",children:(r==null?void 0:r.description)||"No description"}),e.jsxs(m,{sx:{gridColumn:"span 3",display:"flex",gap:2,alignItems:"center",justifyContent:"center"},children:[e.jsx(g,{variant:"body1",sx:{fontWeight:"bold"},children:"Type:"}),e.jsx(g,{variant:"body1",children:r!=null&&r.isPositive?"Positive":"Negative"})]})]}),e.jsxs(P,{sx:{gridColumn:"span 3",borderColor:"#ccc",fontWeight:"bold"},children:[" ","SCALING PER LEVEL"," "]}),e.jsxs(m,{sx:{display:"grid",gridTemplateColumns:["1fr","1fr 1fr","repeat(3, 1fr)"],gridColumn:"span 3",columnGap:2},children:[e.jsx(q,{name:"Max",value:(n=(x=r==null?void 0:r.balance)==null?void 0:x.max)==null?void 0:n.base,even:!1}),e.jsx(q,{name:"Health",value:(d=(b=r==null?void 0:r.balance)==null?void 0:b.health)==null?void 0:d.base,even:!0}),e.jsx(q,{name:"Cost",value:(i=(u=r==null?void 0:r.balance)==null?void 0:u.cost)==null?void 0:i.base,even:!1})]}),e.jsx(P,{sx:{gridColumn:"span 3",borderColor:"#ccc",fontWeight:"bold"},children:"SETTLEMENT POINT COSTS"}),r.settlementPointCost.order.map((h,f)=>e.jsx(q,{name:r.settlementPointCost.data[h].name,value:r.settlementPointCost.data[h].value,even:f%2===0},h)),e.jsx(P,{sx:{gridColumn:"span 3",borderColor:"#ccc",fontWeight:"bold"},children:"THRESHOLDS"}),e.jsx(Te,{data:r.thresholds.data,order:r.thresholds.order})]})},Ke=[{keypath:"name",label:"Name"},{keypath:"description",label:"Description"},{keypath:"balance.maxPerLevel",label:"Max Per Level"},{keypath:"balance.healthPerLevel",label:"Health Per Level"},{keypath:"balance.costPerLevel",label:"Cost Per Level"},{keypath:"settlementPointCost.data",label:"Settlement Point Cost",type:"group"},{keypath:"thresholds.data",label:"Thresholds",type:"group"}],Ye=["name","description","balance","thresholds","settlementPointCost"],it=({tab:t})=>e.jsx(we,{tab:t,initializeTool:Se,validationFields:Ye,editComponent:We,previewComponent:_e,checklistContent:Ke});export{it as default,Ye as validationFields};
