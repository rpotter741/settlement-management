import{a2 as j,r as V,j as u,B as C,I as S,a as $,a1 as k,bs as N,a3 as U,T as I,bF as F,v as R}from"./main.js";import{u as _}from"./useTools.js";import{T as D}from"./ToolInput.js";const B=({id:r,entry:o,data:t,order:i,sort:c=!1})=>{if(t[r])return console.warn(`Entry with id ${r} already exists. Skipping add.`),{data:t,order:i};const d=j.clone(t);d[r]=o;const x=[...i,r];return c&&x.sort((m,h)=>{var e,f,n,p;const g=((e=d[m])==null?void 0:e.max)||((f=d[m])==null?void 0:f.value)||0,s=((n=d[h])==null?void 0:n.max)||((p=d[h])==null?void 0:p.value)||0;return g-s}),{data:d,order:x}},X=({id:r,data:o,order:t})=>{if(!o[r])return console.warn(`Entry with id ${r} does not exist. Skipping remove.`),{data:o,order:t};const i={...o};delete i[r];const c=t.filter(d=>d!==r);return{data:i,order:c}},P=({from:r,to:o,data:t,order:i})=>{if(r<0||r>=i.length||o<0||o>=i.length)return console.warn(`Invalid indices for reorder: from ${r}, to ${o}. Skipping.`),{data:t,order:i};const c=[...i],[d]=c.splice(r,1);return c.splice(o,0,d),{data:t,order:c}},L={add:B,remove:X,reorder:P},O={thresholds:{name:"Threshold name must be at least 3 characters long.",value:null},settlementPointCost:{name:null,value:null}},W=(r,o,t)=>{const{selectEditValue:i,updateTool:c,errors:d,validateToolField:x}=_(r,o),m=i(t),h=d[t]||{},{data:g,order:s}=m;return{data:g,order:s,errors:h,add:({id:p,entry:w,sort:v=!1})=>{const M=L.add({id:p,entry:w,data:g,order:s,sort:v});c(t,M);const a=j.cloneDeep(h);if(!O[t]){console.warn(`Add ${t} in addMap at top of useOrderedData.jsx`);return}a.data[p]={...O[t]},x(`${t}`,a)},remove:p=>{const w=L.remove({id:p,data:g,order:s});c(t,w);const v=j.cloneDeep(h);delete v[p],x(`${t}`,v)},reorder:(p,w)=>{const v=L.reorder({from:p,to:w,data:g,order:s});c(t,v)}}},G=(r,o)=>{const c={...r},d=[],x=new Set;let m=Object.entries(c).map(([s,e])=>({id:s,name:e.name,max:e.max}));const h=s=>{let e=s,f=0;for(;x.has(e)&&f<200;){const n=[...x].filter(l=>l<e),p=[...x].filter(l=>l>e),w=n.length?Math.max(...n):-1/0,v=p.length?Math.min(...p):1/0,M=w===-1/0?e-1:e-(w+1),a=v===1/0?100-e:v-1-e;if(M>=a&&M>0&&e>1)e--;else if(a>0&&e<100)e++;else break;e=Math.max(1,Math.min(100,e)),f++}return e},g=m.findIndex(s=>s.id===o);if(g>=0){let s=m[g],e=s.max,f=Math.max(1,Math.min(100,e)),n=h(f);n!==e&&d.push(`Threshold ${s.name} changed from ${e} to ${n} to prevent duplicates.`),s.max=n,x.add(n),m[g]=s}m.sort((s,e)=>s.max-e.max);for(let s=0;s<m.length;s++){const e=m[s];if(e.id===o)continue;const f=e.max;let n=Math.max(1,Math.min(100,f));x.has(n)&&(n=h(n)),x.has(n)&&(n=h(n)),n!==f&&d.push(`Threshold ${e.name} changed from ${f} to ${n} to prevent duplicates.`),e.max=n,x.add(n),m[s]=e}return m.forEach(s=>{c[s.id]={name:s.name,max:s.max}}),{thresholdsClone:c,changes:d}},q={label:"",type:"text",tooltip:"",validateFn:r=>r.length<3?"Name must be at least 3 characters long":null},z={label:"Value",type:"number",validateFn:r=>r<0||r>100?"Value must be between 0 and 100":null},H=({id:r,handleRemove:o,handleBlur:t})=>u.jsxs(C,{sx:{display:"flex",alignItems:"center",px:{sm:0,md:4,lg:6,xl:8,xxl:12},transition:"top 0.3s ease, left 0.3s ease",gap:2},children:[u.jsx(D,{inputConfig:{...q,keypath:`thresholds.data.${r}.name`},style:{width:"100%"},debounced:!0}),u.jsx(D,{inputConfig:{...z,keypath:`thresholds.data.${r}.max`},style:{width:"66%"},onBlur:t,debounced:!0}),o!==null&&u.jsx(S,{title:"Remove threshold",children:u.jsx($,{variant:"contained","aria-label":"Remove threshold",onClick:o?()=>o(r):()=>{},sx:{px:4},children:"Remove"})})]},r),J=V.memo(H),ee=({max:r=21})=>{const o=k(),{tool:t,id:i}=V.useContext(N),{add:c,remove:d}=W(t,i,"thresholds"),{edit:x,updateTool:m}=_(t,i),h=x.thresholds,[g,s]=V.useState(!1),[e,f]=V.useState(null),n=V.useCallback(j.debounce((a,l)=>{o(U({message:a,type:l}))},300,{leading:!0,trailing:!1}),[U,o]),p=V.useCallback(()=>{const{thresholdsClone:a,changes:l}=G(h.data,e),T=[...h.order].sort((A,y)=>a[A].max-a[y].max);m("thresholds.data",a),m("thresholds.order",T),l&&l.forEach(A=>{n(A,"warning")})},[h.data,h.order,m,e,n]),w=a=>{if(a.order.length===0)return 33;const l=a.order.map(b=>a.data[b]).sort((b,E)=>b.max-E.max);let T=0,A=0;for(let b=0;b<l.length-1;b++){const E=l[b+1].max-l[b].max;E>T&&(T=E,A=Math.floor((l[b+1].max+l[b].max)/2))}l[0].max>T&&(T=l[0].max,A=Math.floor(l[0].max/2));const y=100-l[l.length-1].max;return y>T&&(T=y,A=Math.floor((100+l[l.length-1].max)/2)),A},v=V.useCallback(a=>{d(a)},[d]),M=()=>{if(h.order.length>=r){o(U({message:"I hope 21 is enough! Scaling UIs is hard!",type:"info"})),F({particleCount:100,spread:70,origin:{y:.6}}),s(!0);return}const a=R(),l={id:a,name:"",max:w(h)};c({id:a,entry:l,sort:!0})};return u.jsxs(C,{children:[u.jsxs(I,{variant:"h6",children:[t.charAt(0).toUpperCase()+t.slice(1)," Thresholds"]}),u.jsxs(I,{children:["Thresholds represent ",t," state at a given percentage. They provide both narrative depth and an easy way to set"," ",u.jsx("strong",{children:"Conditions and Listeners"})," without relying on intimate knowledge of the ",t," itself."," "]}),h.order.map(a=>u.jsx(J,{handleRemove:h.order.length>2?v:void 0,handleBlur:p,id:a},a)),g?u.jsx(S,{title:"Back for more? That's what we love about you!",children:u.jsx($,{variant:"contained",color:"success","aria-label":"Add threshold",onClick:M,sx:{px:4},children:"Add Threshold"})}):u.jsx($,{variant:"contained",color:"success","aria-label":"Add threshold",onClick:M,sx:{px:4},children:"Add Threshold"})]})},K=({name:r,value:o,style:t,even:i})=>u.jsxs(C,{sx:{display:"flex",alignItems:"center",width:"100%",position:"relative",backgroundColor:i?"background.default":"background.paper",...t},children:[u.jsxs(I,{variant:"body1",sx:{fontWeight:"bold",width:"100%",textAlign:"start"},children:[j.capitalize(r),":"]}),u.jsx(I,{sx:{fontWeight:"bold",position:"absolute",right:16},children:o})]}),te=({data:r,order:o})=>u.jsx(C,{sx:{gridColumn:"span 3",columnGap:2,display:"grid",gridTemplateRows:"repeat(7, 1fr)",gridTemplateColumns:["1fr","1fr 1fr","repeat(3, 1fr)"],gridAutoFlow:"column"},children:o.map((t,i)=>{const{name:c,max:d}=r[t];return u.jsx(K,{name:c,value:d,style:{width:"100%",maxWidth:"256px"},even:i%2===0},t)})});export{ee as O,te as P,K as R,W as u};
