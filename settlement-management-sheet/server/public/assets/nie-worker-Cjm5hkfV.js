self.onmessage=e=>{};self.addEventListener("error",e=>{console.error("Worker error:",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno})});self.onmessage=e=>{try{const{action:r,nodes:s,entries:c,backlinks:p}=e.data,t=[],a={};if(c.forEach(o=>{t.push(o.id),a[o.id]=o}),r==="buildGraph"){const o=s.length,d=s.reduce((n,l,i)=>{const u=a[l.id],y=p.filter(I=>I.sourceId===l.id||I.targetId===l.id);return n=f({acc:n,node:l,entry:u,backlinks:y,ids:t}),i%10===0&&self.postMessage({action:"progress",current:i+1,total:o,percent:Math.round((i+1)/o*100)}),n},{}),h=Object.values(d).reduce((n,l,i)=>(n=m({acc:n,node:l}),i%10===0&&self.postMessage({action:"anchorProgress",current:i+1,total:Object.values(d).length,percent:Math.round((i+1)/Object.values(d).length*100)}),n),{});self.postMessage({action:"complete",graph:d,anchorMap:h})}}catch(r){console.error("Worker message handler error:",r),self.postMessage({action:"error",error:r.message,stack:r.stack})}};function m({acc:e,node:r}){const s=r.primaryId,c=r.primaryValue,p=r.secondaryId,t=r.secondaryValue;return e[s]||(e[s]={[c]:[]}),e[s][c].push(r.id),e[p]||(e[p]={[t]:[]}),e[p][t].push(r.id),e}function f({acc:e,node:r,entry:s,backlinks:c,ids:p}){const t={id:r.id,name:r.name,type:s.entryType,primaryValue:s.primaryAnchorValue,primaryId:s.primaryAnchorId,primaryName:"",secondaryValue:s.secondaryAnchorValue,secondaryId:s.secondaryAnchorId,secondaryName:"",subTypeId:s.subTypeId,parentId:r.parentId,relationships:{}};return r.parentId&&(t.relationships[r.parentId]={distance:.5,type:"parent"}),r.children&&r.children.forEach(a=>{t.relationships[a.id]={distance:.5,type:"child"}}),c.forEach(a=>{const o=a.sourceId===r.id?a.targetId:a.sourceId,d=a.type==="dropdown"?1:1.5;t.relationships[o]={distance:d,type:a.type}}),e[r.id]=t,e}
